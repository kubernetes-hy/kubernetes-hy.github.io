{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-4/2-messaging-systems","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Learning Objectives"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After this section, you can"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Create a complex microservice architecture with NATS as the messaging system"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Message_queue","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Message queues"}]},{"type":"text","value":" are a method for communication between services. They have a wide range of use cases and are helpful when you want to scale applications. A number of HTTP REST API services that want to communicate with each other require that the services know each otherâ€™s addresses. Whereas when using message queues, messages are sent to and received from the message queue, respectively."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this section we will be using a messaging system called "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"NATS"}]},{"type":"text","value":", to explore the benefits of messaging. Before we get started we will have a look at the basics of NATS."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In NATS applications are communicating by sending and receiving messages. These messages are addressed and identified by "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/subjects","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"subjects"}]},{"type":"text","value":". The sender "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"publishes"}]},{"type":"text","value":" the message with a subject. The receivers "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"subscribe"}]},{"type":"text","value":" to subjects to get the published messages. In the default "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/core-nats/pubsub","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"publish-subscribe"}]},{"type":"text","value":" model of operation, all the subscribers of the subject receive the published message. It is also possible to use a "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/core-nats/queue","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"queue"}]},{"type":"text","value":" model, where each published message is given just to "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"one"}]},{"type":"text","value":" subscriber."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"NATS provides some different message delivery semantics or modes of operation. The basic functionality provided by "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/core-nats","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Core NATS"}]},{"type":"text","value":" is "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"at most once"}]},{"type":"text","value":" messaging: if no subscribers are listening on the subject (no subject match), or are not active when the message is sent, the message is not received. By using the "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/jetstream","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Jetstream"}]},{"type":"text","value":" functionality, it is also possible to achieve "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"at least once"}]},{"type":"text","value":" or "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"exactly once"}]},{"type":"text","value":" messaging with persistence."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With these in mind, we can design our first application that uses messaging for communication."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We have a data set of 100000 JSON objects that we need to do some heavy processing on and then save the processed data. Unfortunately processing a single JSON object takes so long that processing all of the data would require hours of work. To solve this I've split the application into smaller services that we can scale individually."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app9","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"application"}]},{"type":"text","value":" is divided in 3 parts:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Fetcher, which fetches unprocessed data and passes it to NATS."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Mapper, which processes the data from NATS and after processing sends it back to NATS."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Saver, which receives the processed data from NATS and finally (could) save it."}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 26.521739130434778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABKElEQVQY02NgAILLly/r/ccDvn///v/fv3845b98+fKoubmZiwEGjh8/rvz69etlQIl57969WwbCQEP6vn79OhXIXv7+/fvZb968WQTEy4Hi/UDxiUCxxR8/fpz74cOHpQ8ePJg6a9YsbriBN27cSNm9e/emgwcPhhw6dKjr6NGjU0HiQFpzx44dm/bs2eO8a9euqP3790+B6dm+ffvUVatWBe/bty8ZKL7t9u3bjsguVH/x4sX6t2/fLgTauuHRo0cZIPEnT54IP378eCHQ9YuBLlr1/PnzBpD49OnTmZ89e9YNdPFqoGuXAekpQMN5gFKMIHnRxsZGb1BYAA0DhwnQm7NAEteuXRP//PnzJ1AYggDQe8dgjgAGz0VYGALFn8nIyGgBhTkAQeMLiA3MPNAAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/c4b57de891c9b1b647cbbf1a340cc07a/a0b58/app9-plan.webp 230w","/static/c4b57de891c9b1b647cbbf1a340cc07a/bc10c/app9-plan.webp 460w","/static/c4b57de891c9b1b647cbbf1a340cc07a/df8c5/app9-plan.webp 649w"],"sizes":["(max-width:","649px)","100vw,","649px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/c4b57de891c9b1b647cbbf1a340cc07a/81c8e/app9-plan.png 230w","/static/c4b57de891c9b1b647cbbf1a340cc07a/08a84/app9-plan.png 460w","/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png 649w"],"sizes":["(max-width:","649px)","100vw,","649px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png","alt":"app9 plan","title":"app9 plan","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As mentioned the messaging in NATS is centered around "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"subjects"}]},{"type":"text","value":". In general, there is one subject per purpose. The app uses four subjects:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 591px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 40.869565217391305%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8UlEQVQoz3WS16qGQAyE9/2f0Asv7GLDgr3l8AUiyw8nEHU3mckk0dV1LUmSyLIssq6rOt/mnI/jUN/3/cvx3fLmeRbH4zxP+c/e95WyLCVNU6H4fd96Z/5rDmbMFEDeNI3EcawkFPRVXNclz/OoQw7GL/ARWiKXKAmCQMIwVMCv4qIoJIoiMSw4i7lxHKWqKlXVdZ20bSvDMHxOu1mWqVJi5PV9r7nE6QQB0zTp2dEKH3mea1sAfbOCkNkSzOgKLOQQctaWmQVVkc7Zhm0zsrlixK3Fbds+jBVyLAMVzIS3bdyGDCEtsyBA/h9BQe78+B97sGtOyQ3PUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/73618f46d88e88e3b31cb23e1bd5c36b/a0b58/nats2.webp 230w","/static/73618f46d88e88e3b31cb23e1bd5c36b/bc10c/nats2.webp 460w","/static/73618f46d88e88e3b31cb23e1bd5c36b/48c21/nats2.webp 591w"],"sizes":["(max-width:","591px)","100vw,","591px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/73618f46d88e88e3b31cb23e1bd5c36b/81c8e/nats2.png 230w","/static/73618f46d88e88e3b31cb23e1bd5c36b/08a84/nats2.png 460w","/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png 591w"],"sizes":["(max-width:","591px)","100vw,","591px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png","alt":"nats2","title":"nats2","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Fetcher splits the data into chunks of 100 objects and keeps a record of which chunks have not been processed. The application is designed so that the Fetcher can not be scaled."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The Fetcher subscribes to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"mapper_status"}]},{"type":"text","value":" and will wait for a Mapper to publish a message confirming that it's ready to process data. When the Fetcher receives this information, it publishes a chunk of data to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"mapper_data"}]},{"type":"text","value":" and starts again from the beginning."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As mentioned, when a mapper is ready to process more data, it publishes the info of availability to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"mapper_status"}]},{"type":"text","value":". It also subscribes to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"mapper_data"}]},{"type":"text","value":". When the Mapper gets a message, it processes it and publishes the processed data to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"saver_data"}]},{"type":"text","value":" and starts all over again. The subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"mapper_data"}]},{"type":"text","value":" operates in "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/nats-concepts/core-nats/queue","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"queue"}]},{"type":"text","value":" mode so each published message is received by only one Mapper."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The Saver subscribes to subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"saver_data"}]},{"type":"text","value":". Once receiving a message it saves it and publishes an acknowledgement message in the subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"processed_data"}]},{"type":"text","value":". The Fetcher subscribes to this subject and keeps track of what chunks of data have been saved. So even if any part of the application crashes all of the data will eventually be processed and saved. Also, the subject "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"saver_data"}]},{"type":"text","value":" is used in queue mode so each chunk of processed data is taken care of only one Saver."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For simplicity, saving to a database and fetching from external API are omitted from our app."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Before deploying the app we shall use Helm to install NATS into our cluster. Instead of the Helm chart provided by the NATS team, we shall use the chart provided by "},{"type":"element","tagName":"a","properties":{"href":"https://bitnami.com/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Bitnami"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The chart is "},{"type":"element","tagName":"a","properties":{"href":"https://artifacthub.io/packages/helm/bitnami/nats","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"documentation"}]},{"type":"text","value":" describe a set of\n"},{"type":"element","tagName":"a","properties":{"href":"https://artifacthub.io/packages/helm/bitnami/nats#parameters","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"parameters"}]},{"type":"text","value":" that can be used to modify the NATS configuration. Let us now disable the authentication by setting "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"auth.enabled"}]},{"type":"text","value":" to value "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"false"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Parameters can be set in the installation as follows:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ helm install --set auth.enabled=false my-nats oci://registry-1.docker.io/bitnamicharts/nats\n\n  NAME: my-nats\n  LAST DEPLOYED: Wed May  8 22:57:17 2024\n  NAMESPACE: default\n  STATUS: deployed\n  REVISION: 1\n  ...\n  NATS can be accessed via port 4222 on the following DNS name from within your cluster:\n\n   my-nats.default.svc.cluster.local\n\n  NATS monitoring service can be accessed via port 8222 on the following DNS name from within your cluster:\n\n    my-nats.default.svc.cluster.local\n\n  To access the Monitoring svc from outside the cluster, follow the steps below:\n\n  1. Get the NATS monitoring URL by running:\n\n      echo \"Monitoring URL: http://127.0.0.1:8222\"\n      kubectl port-forward --namespace default svc/my-nats 8222:8222\n\n  2. Open a browser and access the NATS monitoring browsing to the Monitoring URL\n  ..."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The installation prints many kinds of useful info for us."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We are now ready to deploy our "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app9","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"app"}]},{"type":"text","value":" that uses "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/nats-io/nats.js","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"nats.js"}]},{"type":"text","value":" as the client library. Note that the example app uses nats.js version 1.5. The current version of the library has"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]},{"type":"text","value":" that passes the connect URL "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"nats://my-nats:4222"}]},{"type":"text","value":" to pods in env variable "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"NATS_URL"}]},{"type":"text","value":" looks like the following:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" mapper\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"mapper"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"---"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" fetcher\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"fetcher"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"---"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" saver\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"saver"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"0bcd6794804c367684a9a79bb142bb4455096974\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"env"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" NATS_URL\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"value"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//my"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"nats"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4222"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After applying the deployments we can confirm that everything works by reading the logs of the fetcher - "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl logs fetcher-dep-7d799bb6bf-zz8hr -f"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"Ready to send "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#827"}]},{"type":"text","value":"\nSent data "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#827, 831 remaining"}]},{"type":"text","value":"\nReady to send "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#776"}]},{"type":"text","value":"\nSent data "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#776, 830 remaining"}]},{"type":"text","value":"\nReady to send "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#516"}]},{"type":"text","value":"\nSent data "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#516, 829 remaining"}]},{"type":"text","value":"\nReady to send "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#382"}]},{"type":"text","value":"\nSent data "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#382, 828 remaining"}]},{"type":"text","value":"\nReady to send "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#709"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":"."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We'll want to monitor the state of NATS as well. NATS has a "},{"type":"element","tagName":"a","properties":{"href":"https://docs.nats.io/running-a-nats-service/nats_admin/monitoring","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"web service"}]},{"type":"text","value":" that provides many kinds of data for monitoring. We can access the service from the browser with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl port-forward my-nats-0 8222:8222"}]},{"type":"text","value":" in "},{"type":"element","tagName":"a","properties":{"href":"http://localhost:8222","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://localhost:8222"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/1810905f8affaca4a4328e7f085c2a76/799f3/nats-stats.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9UlEQVQoz52QTUsDMRCG80/Fixevgnj0R3gSvAiehYpQeiqIIIKtWJTaarsfzbq72WTNMt1kkt3Y1rPV+MxcH953hiBqZ9BqJTlkCc/zYgl2Ca6qbCnV9iWstldh3Q3T6+C+Nx71bmd3L8Mx72Ywdc61q/kZMuJqt8/3+4ODm9O9i7Odo8vj85PO6+Fg0VnLbbNNNk37LJCCTkFklYySz0KWH+JdAne/QQwiSxIF4PwhSuP0LQjChTFm03N9ZbvhD7LSUUQpTbVG/2Sl4pjO55EQ5Xeyh1zXajKZMcatbbyTtV7Vjhlj/3kYgB0+FE+PJcvRt/YXRmt6wDDQwLgAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1810905f8affaca4a4328e7f085c2a76/a0b58/nats-stats.webp 230w","/static/1810905f8affaca4a4328e7f085c2a76/bc10c/nats-stats.webp 460w","/static/1810905f8affaca4a4328e7f085c2a76/966d8/nats-stats.webp 920w","/static/1810905f8affaca4a4328e7f085c2a76/445df/nats-stats.webp 1380w","/static/1810905f8affaca4a4328e7f085c2a76/ee7fd/nats-stats.webp 1642w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/1810905f8affaca4a4328e7f085c2a76/81c8e/nats-stats.png 230w","/static/1810905f8affaca4a4328e7f085c2a76/08a84/nats-stats.png 460w","/static/1810905f8affaca4a4328e7f085c2a76/c0255/nats-stats.png 920w","/static/1810905f8affaca4a4328e7f085c2a76/b1001/nats-stats.png 1380w","/static/1810905f8affaca4a4328e7f085c2a76/799f3/nats-stats.png 1642w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/1810905f8affaca4a4328e7f085c2a76/c0255/nats-stats.png","alt":"nats stats","title":"nats stats","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We are already committed to using Prometheus for monitoring and for that, we need to do some configurations. Firstly we have to enable the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/nats-io/prometheus-nats-exporter","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Prometheus exporter"}]},{"type":"text","value":", which exposes the metrics to port 7777. From the Helm chart "},{"type":"element","tagName":"a","properties":{"href":"https://artifacthub.io/packages/helm/bitnami/nats#metrics-parameters","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"documentation"}]},{"type":"text","value":" we find out that "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"metrics.enabled"}]},{"type":"text","value":" should be set to "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" to enable metrics."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The command "},{"type":"element","tagName":"a","properties":{"href":"https://helm.sh/docs/helm/helm_upgrade/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"helm upgrade"}]},{"type":"text","value":" does the trick:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ helm upgrade --set metrics.enabled"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":"true,auth.enabled"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":"false my-nats oci://registry-1.docker.io/bitnamicharts/nats\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":".\n  "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3"}]},{"type":"text","value":". Get the NATS Prometheus Metrics URL by running:\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Prometheus Metrics URL: http://127.0.0.1:7777/metrics\""}]},{"type":"text","value":"\n    kubectl port-forward --namespace default svc/my-nats-metrics "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"7777"}]},{"type":"text","value":":7777\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":". Access NATS Prometheus metrics by opening the URL obtained "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"in"}]},{"type":"text","value":" a browser."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The output already gives us instructions on how we can connect to the exported with the browser. Let us do it to ensure that everything works:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"kubectl port-forward --namespace default svc/my-nats-metrics "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"7777"}]},{"type":"text","value":":7777"}]}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/02be38e535e6f15ad8e2e447228cbc71/913b9/nats-metrics.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 26.08695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkUlEQVQY04WNwQ6DIBBE/f9/wwSFgAc8QFo0oAGKDYVIu9pz7ctmM5d50+ScSynb9pzm9XY3elpn40PMxz1e/vIapZQQQkoJQR4o59y+7/mk1vr+TUMIQQj1fd91HWSMsTEmhLAsi/ceLFdlSmnbtuQEFOM4xhittV/Fn2XOOawxxiBAH/4wDKDQWsNySumi/AHXFRnCTkM/+AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/02be38e535e6f15ad8e2e447228cbc71/a0b58/nats-metrics.webp 230w","/static/02be38e535e6f15ad8e2e447228cbc71/bc10c/nats-metrics.webp 460w","/static/02be38e535e6f15ad8e2e447228cbc71/966d8/nats-metrics.webp 920w","/static/02be38e535e6f15ad8e2e447228cbc71/445df/nats-metrics.webp 1380w","/static/02be38e535e6f15ad8e2e447228cbc71/e3771/nats-metrics.webp 1822w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/02be38e535e6f15ad8e2e447228cbc71/81c8e/nats-metrics.png 230w","/static/02be38e535e6f15ad8e2e447228cbc71/08a84/nats-metrics.png 460w","/static/02be38e535e6f15ad8e2e447228cbc71/c0255/nats-metrics.png 920w","/static/02be38e535e6f15ad8e2e447228cbc71/b1001/nats-metrics.png 1380w","/static/02be38e535e6f15ad8e2e447228cbc71/913b9/nats-metrics.png 1822w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/02be38e535e6f15ad8e2e447228cbc71/c0255/nats-metrics.png","alt":"nats metrics","title":"nats metrics","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Connecting Prometheus to the exporter requires a new resource "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ServiceMonitor"}]},{"type":"text","value":", which is another "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Custom Resource Definition"}]},{"type":"text","value":" (CDR)."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We could create the resource by ourselves but that is not needed since with a little more configuration, the Helm chart will do it for us. The following settings will create the ServiceMonitor:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Â´Â´Â´\nmetrics.serviceMonitor.enabled=true\nmetrics.serviceMonitor.namespace=prometheus\nÂ´Â´Â´"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Since we are already setting value to quite many parameters, let us define those in a file:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"myvalues.yaml"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Â´Â´Â´yaml\nauth:\nenabled: false"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"metrics:\nenabled: true\nserviceMonitor:\nenabled: true\nnamespace: prometheus\nÂ´Â´Â´"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we are ready to upgrade the chart:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Â´Â´Â´bash\nhelm upgrade -f myvalyes.yaml my-nats oci://registry-1.docker.io/bitnamicharts/nats\nÂ´Â´Â´"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can confirm that the ServiceMonitor "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"my-nats-metrics"}]},{"type":"text","value":" is indeed created:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Â´Â´Â´bash\n$ kubectl get servicemonitors.monitoring.coreos.com -n prometheus\nNAME                                                        AGE\nkube-prometheus-stack-1714-alertmanager                     6d10h\nkube-prometheus-stack-1714-apiserver                        6d10h\nkube-prometheus-stack-1714-coredns                          6d10h\nkube-prometheus-stack-1714-kube-controller-manager          6d10h\nkube-prometheus-stack-1714-kube-etcd                        6d10h\nkube-prometheus-stack-1714-kube-proxy                       6d10h\nkube-prometheus-stack-1714-kube-scheduler                   6d10h\nkube-prometheus-stack-1714-kubelet                          6d10h\nkube-prometheus-stack-1714-operator                         6d10h\nkube-prometheus-stack-1714-prometheus                       6d10h\nkube-prometheus-stack-1714644114-grafana                    6d10h\nkube-prometheus-stack-1714644114-kube-state-metrics         6d10h\nkube-prometheus-stack-1714644114-prometheus-node-exporter   6d10h\nmy-nats-metrics                                             8m8s\nÂ´Â´Â´"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We still need a suitable label for our configuration so that Prometheus knows to listen to the NATS."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's use the label that the already existing ServiceMonitors are using. We can check it with the following commands:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus get prometheus\n  NAME                                    VERSION   REPLICAS   AGE\n  kube-prometheus-stack-1714-prometheus   v2.51.2   1          39h\n\n$ kubectl describe prometheus -n prometheus kube-prometheus-stack-1714-prometheus\n...\n  Service Monitor Selector:\n    Match Labels:\n      Release:  kube-prometheus-stack-1714644114\n..."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So the label needs to be "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"release: kube-prometheus-stack-1714644114"}]},{"type":"text","value":" unless we'd like to define a new Prometheus resource. Label is set as the value of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"metrics.service.labels"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Label can be attached to the ServiceMonitor with "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/kubectl/generated/kubectl_label/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"kubectl label"}]},{"type":"text","value":" command:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Â´Â´Â´bash\nkubectl label servicemonitors.monitoring.coreos.com -n prometheus my-nats-metrics release=kube-prometheus-stack-1714644114\nÂ´Â´Â´"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now Prometheus should have access to the new data. Let's check Prometheus:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 9090\nForwarding from 127.0.0.1:9090 -> 9090\nForwarding from [::1]:9090 -> 9090"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If all goes well, the NATS metrics ServiceMonitor is among the list of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"targets"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/8abe0816139a8d54397699ae423886d6/0ff19/nats-prome.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 40.43478260869565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABYlAAAWJQFJUiTwAAABaUlEQVQY04WQS0vDQBSF8yMr2lZSrVYUXyAIbtwJggt/heBGxYUv0NpqXVTRtht15atNJs1Mps3MJBPbTDJOU7sTPHzcy+Wec2FGq9Ubj0+1yl315LyoOL24vrgslyv3pdvqv2hr6xvziysLS6u5/JyeL+jThcmp2WxuZjybG8voE1l9PKOn0n+j2ZgYdtewOwC5JnRBgoVcyyFq9dEmJiKMkqFcQigdDYRoOJAGlSaVgEmDSItJ5EuQjN1AFt9lw5JKUTyocRyHQsiRNBs6Du6IKOqFodoxn2AXyUiANvS/QxGJOFL+yOe81TIQcp5fXi2rzYNARTTToW/AbUH2aVOIvSYyv2DT6XqbZ3z5ONwp9SxMewHDGH9+NSGEAAB1gibSuO97jA5Rb1Ode56NaeFQpPZEel8c1PmL4TldxpVxoEH9DTPPdwkllCkoZW7SUIft3vS2rvrbxf5RI3h45208iKj/GkIT8w9jgY9RwiwG3QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/8abe0816139a8d54397699ae423886d6/a0b58/nats-prome.webp 230w","/static/8abe0816139a8d54397699ae423886d6/bc10c/nats-prome.webp 460w","/static/8abe0816139a8d54397699ae423886d6/966d8/nats-prome.webp 920w","/static/8abe0816139a8d54397699ae423886d6/445df/nats-prome.webp 1380w","/static/8abe0816139a8d54397699ae423886d6/78de1/nats-prome.webp 1840w","/static/8abe0816139a8d54397699ae423886d6/3c5e9/nats-prome.webp 2084w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/8abe0816139a8d54397699ae423886d6/81c8e/nats-prome.png 230w","/static/8abe0816139a8d54397699ae423886d6/08a84/nats-prome.png 460w","/static/8abe0816139a8d54397699ae423886d6/c0255/nats-prome.png 920w","/static/8abe0816139a8d54397699ae423886d6/b1001/nats-prome.png 1380w","/static/8abe0816139a8d54397699ae423886d6/161ec/nats-prome.png 1840w","/static/8abe0816139a8d54397699ae423886d6/0ff19/nats-prome.png 2084w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/8abe0816139a8d54397699ae423886d6/c0255/nats-prome.png","alt":"nats prome","title":"nats prome","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can now query the data:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/3a94ec2b72108834b13ccf8dae5a3b08/701e9/nats-prome2.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 35.65217391304348%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYElEQVQY02WPzU7CQBSF+0yikRKkBsREFrBwwcZI4nu4NvEJfAU1MYDaApYfFSWBuHIhKoQCZUqhBLTttLSl4y2J0eiXk8zNyZw5c6m91EE0ltiJ74a3Y3QoEmCigc1ogNkKMJH1YHjFH1qlQ2t0yEfDwPhA/qB/I5xI7seTKeqCb9xUqqX7WrpYT+cqHH/L8ZUs/3DO3V3nS9lcMZMvn7LVDFdMs/xVoXSWe7wslBv1WvP5iZrp9nyJZjp4btu2QwhxCVmQH37PH9gWx+oxrx6yOmVgQ9P16Sc2AIwty/LCCwe0+MZ1HQDDFdOczmZdpJyUR0esRL23O5IsqxbRTa9zpExEJHl51yX/+GNSL68tcYBMAyuTiappnW6v+daCfvgH7GJ4ZaaxPEDggwmrLVyCzTkFviB0EZIQQoIgKIoyVpRWuy2KgwGS+v1+r9eTpKE8Gg1lWdd1VVUhD7Xw6BdcpVgMLxeUAAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/3a94ec2b72108834b13ccf8dae5a3b08/a0b58/nats-prome2.webp 230w","/static/3a94ec2b72108834b13ccf8dae5a3b08/bc10c/nats-prome2.webp 460w","/static/3a94ec2b72108834b13ccf8dae5a3b08/966d8/nats-prome2.webp 920w","/static/3a94ec2b72108834b13ccf8dae5a3b08/445df/nats-prome2.webp 1380w","/static/3a94ec2b72108834b13ccf8dae5a3b08/e11e5/nats-prome2.webp 1780w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/3a94ec2b72108834b13ccf8dae5a3b08/81c8e/nats-prome2.png 230w","/static/3a94ec2b72108834b13ccf8dae5a3b08/08a84/nats-prome2.png 460w","/static/3a94ec2b72108834b13ccf8dae5a3b08/c0255/nats-prome2.png 920w","/static/3a94ec2b72108834b13ccf8dae5a3b08/b1001/nats-prome2.png 1380w","/static/3a94ec2b72108834b13ccf8dae5a3b08/701e9/nats-prome2.png 1780w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/3a94ec2b72108834b13ccf8dae5a3b08/c0255/nats-prome2.png","alt":"nats prome2","title":"nats prome2","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Also the Prometheus API should return a result:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ curl http://localhost:9090/api/v1/query\\?query\\=gnatsd_connz_in_msgs\n  {\n    \"status\":\"success\",\n    \"data\":{\n        \"resultType\":\"vector\",\n        \"result\":[\n          {\n              \"metric\":{\n                \"__name__\":\"gnatsd_connz_in_msgs\",\n                \"container\":\"metrics\",\n                \"endpoint\":\"tcp-metrics\",\n                \"instance\":\"10.40.0.138:7777\",\n                \"job\":\"my-nats-metrics\",\n                \"namespace\":\"default\",\n                \"pod\":\"my-nats-0\",\n                \"server_id\":\"http://localhost:8222\",\n                \"service\":\"my-nats-metrics\"\n              },\n              \"value\":[\n                1715203297.971,\n                \"1997\"\n              ]\n          }\n        ]\n    }\n  }"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If the result here is empty then something is wrong, the result may be a success even if the query doesn't make sense."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we just need to add a Grafana dashboard for the data. Let's import a dashboard from "},{"type":"element","tagName":"a","properties":{"href":"https://raw.githubusercontent.com/nats-io/prometheus-nats-exporter/5084a32850823b59069f21f3a7dde7e488fef1c6/walkthrough/grafana-nats-dash.json","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":" instead of configuring our own."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus port-forward kube-prometheus-stack-1602180058-grafana-59cd48d794-4459m 3000"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here we can paste the JSON using the \"Import dashboard\" and by choosing Prometheus as the source on the following page."}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/7c3ddafc2c33d33d2bb1a40e93098224/0faf1/grafana-import2.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 26.08695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7ElEQVQY002Py07DMBBF/Q2QOPHbju24cSBpUYuAHeoXQ3k1iCSVoCAW7PkbJu0G6Wh0fDUz8qDn7dvd5uV+s314eu2Hj2HcT+w+gX7c98PBDyE833dfv+PP92MHfV3XIS4LoSwAQrkGuDBSOYCJgjAlNYie4BozuVIx6JAr63xESUoSTE+TqWa5OIJzDjXNGIQpZiA44ycJuQyL9fX6dn5DMc+oRLFezOK8aVdVbHMiCVVHwE0R6rOLUDXGBlfWQrvGn1/Vy2XZauUhRNZXhat8qEHgk/+QcIixM21KZUroUcbnXKdUArAIhv8AK7lLT9wOuCgAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/7c3ddafc2c33d33d2bb1a40e93098224/a0b58/grafana-import2.webp 230w","/static/7c3ddafc2c33d33d2bb1a40e93098224/bc10c/grafana-import2.webp 460w","/static/7c3ddafc2c33d33d2bb1a40e93098224/966d8/grafana-import2.webp 920w","/static/7c3ddafc2c33d33d2bb1a40e93098224/445df/grafana-import2.webp 1380w","/static/7c3ddafc2c33d33d2bb1a40e93098224/78de1/grafana-import2.webp 1840w","/static/7c3ddafc2c33d33d2bb1a40e93098224/8488f/grafana-import2.webp 1956w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/7c3ddafc2c33d33d2bb1a40e93098224/81c8e/grafana-import2.png 230w","/static/7c3ddafc2c33d33d2bb1a40e93098224/08a84/grafana-import2.png 460w","/static/7c3ddafc2c33d33d2bb1a40e93098224/c0255/grafana-import2.png 920w","/static/7c3ddafc2c33d33d2bb1a40e93098224/b1001/grafana-import2.png 1380w","/static/7c3ddafc2c33d33d2bb1a40e93098224/161ec/grafana-import2.png 1840w","/static/7c3ddafc2c33d33d2bb1a40e93098224/0faf1/grafana-import2.png 1956w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/7c3ddafc2c33d33d2bb1a40e93098224/c0255/grafana-import2.png","alt":"grafana import2","title":"grafana import2","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And now we have a simple dashboard with data:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 47.39130434782609%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABXUlEQVQoz31Sx3bDMAzzPc1wbE1aXnFGm/7/76EEnbg99YAniaRAAlJVJCFJj8Oxxu7jgN3+iP3htO7/wYfW1ecWJ6Ju0bQBOXeoQu7RuICzBhoXDSF1aEOCi2mNac5i/vccpRhar2eFj9nIK04XlFnKiNwNKOOEbhwxLDOG24xumFCmGdJrXJG1jvvptmC6XxS6PhZcvu46lNcJE8kGpKwddR9tkoi6cTaJ085tEFMQkqg9xab1UayGcCHDp6JW1SSUTQ4vh45JUbJVuk96fvlMuSRyKSEWsTtE6nqtSwgiqFhAKZQ8P65YnjeVucoXXefPq0kqw2x1tGR53k0qm5CsV3uW7zv6y4SKXYv6RKlv2fSCJkf19q3A6SQhyussJpOPmZWUdxjzGjNCjm0eKYEV+ri9eN14i0VtxhpiJVvzjLcubbnq/U2YeCPk1fi/cTYLr9xW+/o6lM6VuR9BG+eLfbbg/AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9805594f4c1b4bdea7a35f4534b4f1e1/a0b58/grafana-nats.webp 230w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/bc10c/grafana-nats.webp 460w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/966d8/grafana-nats.webp 920w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/445df/grafana-nats.webp 1380w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/78de1/grafana-nats.webp 1840w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/27d84/grafana-nats.webp 2056w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9805594f4c1b4bdea7a35f4534b4f1e1/81c8e/grafana-nats.png 230w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/08a84/grafana-nats.png 460w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png 920w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/b1001/grafana-nats.png 1380w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/161ec/grafana-nats.png 1840w","/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png 2056w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png","alt":"grafana nats","title":"grafana nats","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is now the final configuration:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 90.8695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAACmElEQVQ4y5VUS08aURS+2G278Je0a8If0HUb9y5NYzdtmpadC0xpXJjQJoY2RZJCdWjlIRQUCQGMxIUYNeALiIpEectbBG+/M5kxxBTBm5zMnXvO+c4335lzGbu3AoEA45yL+/Pz8+VOp8Nzudx1Pp+/pj3OXOSjmM3NTdZ3bW1t3QFWq1Uf9vzi4oJAacsrlYpfBozFYv0B/X7/HeDp6emncrkcBrAHzxWAbZycnHyWAcPhMBt4IUFBT5VK9dThcLy32+0flErlMzoDsGJgoNXV1TuGR0dHL0ul0tT+/v7cwcHBHHScOj4+fiUzDAaD/QFJaBnw6uoqSLpls1l+eXkpaogC6zLgzs7O4wCR7CCQYrHYAruWBOh8FGB3U9CAv6lUiu/u7tYikUgtnU7zs7Mzz4NNMRqNTBAEtrCwwBYXF5nP52Mej4f0U+zt7T1HgdGlpaVxxIyHQqHRaDT6AoUULpeLra2tiTndRpWG7pkC9qS7KBInvV7v63t/wdD/rOeng90YPlPvdrtnnE7nF7DWwWa2t7f1YDnWMxGaGCC0AaIbCoWCAQ2YR1f1OEtTE9Bpmg7R4OPSWRox3yiWcuRcMsYHWJgSXq/XBwnlxNCI6oZ4PP4H/9pPMJtHxR+Y3XkwEAAmYASX0W0H4gSwE+AXYygWc25KJBK/EUcMjT2l0Gg0wzab7Q26OWEymd6Zzea3Vqt1wmKxTGq12uGHNNTVarVZ/ApUVUeVk8nkCPkODw8/4t2MmF9gaYZuJtwwavKB1Qh833H2FbkGMJwFQx3r1qndbot7fO60dH2tS+9iU6Tra4N8AJqWc7v1pZujdXt724IeN41Goy7NrloaPbc0ek1o15T2K+TLZDJqem82m3WQuSEMsn8gdgt23IAbZgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/709982b7337c907e82909551fcb98e51/a0b58/app9-nats-prometheus-grafana.webp 230w","/static/709982b7337c907e82909551fcb98e51/24c94/app9-nats-prometheus-grafana.webp 441w"],"sizes":["(max-width:","441px)","100vw,","441px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/709982b7337c907e82909551fcb98e51/81c8e/app9-nats-prometheus-grafana.png 230w","/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png 441w"],"sizes":["(max-width:","441px)","100vw,","441px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png","alt":"app9 nats prometheus grafana","title":"app9 nats prometheus grafana","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.06: Project v2.0"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"If you use JavaScript, notice that the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes-hy/material-example/tree/master/app9","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"example app"}]},{"type":"text","value":" uses nats.js library version 1.5. The "},{"type":"element","tagName":"a","properties":{"href":"https://www.npmjs.com/package/nats","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"current version"}]},{"type":"text","value":" of the library has significant changes in the API, so copy-pasting the code from the example will not work."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Create a new separate service for sending status messages of the todos to a popular chat application. Let's call the new service \"broadcaster\"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Requirements:"}]},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The backend saving or updating todos should send a message to NATS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The broadcaster should subscribe to NATS messages"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The broadcaster should send the message forward to "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"an external service"}]},{"type":"text","value":" in a format they support"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  As the external service you can choose either:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Discord (you can use the course Full stack Discord, see "},{"type":"element","tagName":"a","properties":{"href":"https://fullstackopen.com/en/part11/expanding_further#exercise-11-18","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"here"}]},{"type":"text","value":" for the details)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Telegram"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Slack"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  or if you don't want to use them, use \"Generic\" where a URL is set as an Environment variable and the payload is e.g."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"user\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"bot\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"message\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"A todo was created\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  The broadcaster should be able to be scaled without sending the message multiple times. Test that it can run with 6 replicas without issues. The messages only have to be sent to the external service if all of the services are working correctly. So a randomly missing message is not an issue but a duplicate is."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Example of a working broadcaster:\n"},{"type":"element","tagName":"img","properties":{"src":"/373b4b99e844fb5340312e7460d81ccf/ex406-solution.gif"},"children":[]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  You should not write the API key in plain text."}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Learning Objectives'><p>After this section, you can</p><ul>\n<li>Create a complex microservice architecture with NATS as the messaging system</li>\n</ul></text-box><p><a href=\"https://en.wikipedia.org/wiki/Message_queue\" target=\"_blank\" rel=\"noopener noreferrer\">Message queues</a> are a method for communication between services. They have a wide range of use cases and are helpful when you want to scale applications. A number of HTTP REST API services that want to communicate with each other require that the services know each otherâ€™s addresses. Whereas when using message queues, messages are sent to and received from the message queue, respectively.</p><p>In this section we will be using a messaging system called <a href=\"https://docs.nats.io/\" target=\"_blank\" rel=\"noopener noreferrer\">NATS</a>, to explore the benefits of messaging. Before we get started we will have a look at the basics of NATS.</p><p>In NATS applications are communicating by sending and receiving messages. These messages are addressed and identified by <a href=\"https://docs.nats.io/nats-concepts/subjects\" target=\"_blank\" rel=\"noopener noreferrer\">subjects</a>. The sender <em>publishes</em> the message with a subject. The receivers <em>subscribe</em> to subjects to get the published messages. In the default <a href=\"https://docs.nats.io/nats-concepts/core-nats/pubsub\" target=\"_blank\" rel=\"noopener noreferrer\">publish-subscribe</a> model of operation, all the subscribers of the subject receive the published message. It is also possible to use a <a href=\"https://docs.nats.io/nats-concepts/core-nats/queue\" target=\"_blank\" rel=\"noopener noreferrer\">queue</a> model, where each published message is given just to <strong>one</strong> subscriber.</p><p>NATS provides some different message delivery semantics or modes of operation. The basic functionality provided by <a href=\"https://docs.nats.io/nats-concepts/core-nats\" target=\"_blank\" rel=\"noopener noreferrer\">Core NATS</a> is <em>at most once</em> messaging: if no subscribers are listening on the subject (no subject match), or are not active when the message is sent, the message is not received. By using the <a href=\"https://docs.nats.io/nats-concepts/jetstream\" target=\"_blank\" rel=\"noopener noreferrer\">Jetstream</a> functionality, it is also possible to achieve <em>at least once</em> or <em>exactly once</em> messaging with persistence.</p><p>With these in mind, we can design our first application that uses messaging for communication.</p><p>We have a data set of 100000 JSON objects that we need to do some heavy processing on and then save the processed data. Unfortunately processing a single JSON object takes so long that processing all of the data would require hours of work. To solve this I've split the application into smaller services that we can scale individually.</p><p>The <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app9\" target=\"_blank\" rel=\"noopener noreferrer\">application</a> is divided in 3 parts:</p><ul>\n<li>Fetcher, which fetches unprocessed data and passes it to NATS.</li>\n<li>Mapper, which processes the data from NATS and after processing sends it back to NATS.</li>\n<li>Saver, which receives the processed data from NATS and finally (could) save it.</li>\n</ul><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 649px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.521739130434778%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABKElEQVQY02NgAILLly/r/ccDvn///v/fv3845b98+fKoubmZiwEGjh8/rvz69etlQIl57969WwbCQEP6vn79OhXIXv7+/fvZb968WQTEy4Hi/UDxiUCxxR8/fpz74cOHpQ8ePJg6a9YsbriBN27cSNm9e/emgwcPhhw6dKjr6NGjU0HiQFpzx44dm/bs2eO8a9euqP3790+B6dm+ffvUVatWBe/bty8ZKL7t9u3bjsguVH/x4sX6t2/fLgTauuHRo0cZIPEnT54IP378eCHQ9YuBLlr1/PnzBpD49OnTmZ89e9YNdPFqoGuXAekpQMN5gFKMIHnRxsZGb1BYAA0DhwnQm7NAEteuXRP//PnzJ1AYggDQe8dgjgAGz0VYGALFn8nIyGgBhTkAQeMLiA3MPNAAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/a0b58/app9-plan.webp 230w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/bc10c/app9-plan.webp 460w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/df8c5/app9-plan.webp 649w\" sizes=\"(max-width: 649px) 100vw, 649px\" type=\"image/webp\">\n        <source srcset=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/81c8e/app9-plan.png 230w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/08a84/app9-plan.png 460w,\n/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png 649w\" sizes=\"(max-width: 649px) 100vw, 649px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/c4b57de891c9b1b647cbbf1a340cc07a/7762d/app9-plan.png\" alt=\"app9 plan\" title=\"app9 plan\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>As mentioned the messaging in NATS is centered around <em>subjects</em>. In general, there is one subject per purpose. The app uses four subjects:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 591px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.869565217391305%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8UlEQVQoz3WS16qGQAyE9/2f0Asv7GLDgr3l8AUiyw8nEHU3mckk0dV1LUmSyLIssq6rOt/mnI/jUN/3/cvx3fLmeRbH4zxP+c/e95WyLCVNU6H4fd96Z/5rDmbMFEDeNI3EcawkFPRVXNclz/OoQw7GL/ARWiKXKAmCQMIwVMCv4qIoJIoiMSw4i7lxHKWqKlXVdZ20bSvDMHxOu1mWqVJi5PV9r7nE6QQB0zTp2dEKH3mea1sAfbOCkNkSzOgKLOQQctaWmQVVkc7Zhm0zsrlixK3Fbds+jBVyLAMVzIS3bdyGDCEtsyBA/h9BQe78+B97sGtOyQ3PUAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/73618f46d88e88e3b31cb23e1bd5c36b/a0b58/nats2.webp 230w,\n/static/73618f46d88e88e3b31cb23e1bd5c36b/bc10c/nats2.webp 460w,\n/static/73618f46d88e88e3b31cb23e1bd5c36b/48c21/nats2.webp 591w\" sizes=\"(max-width: 591px) 100vw, 591px\" type=\"image/webp\">\n        <source srcset=\"/static/73618f46d88e88e3b31cb23e1bd5c36b/81c8e/nats2.png 230w,\n/static/73618f46d88e88e3b31cb23e1bd5c36b/08a84/nats2.png 460w,\n/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png 591w\" sizes=\"(max-width: 591px) 100vw, 591px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/73618f46d88e88e3b31cb23e1bd5c36b/e4c9a/nats2.png\" alt=\"nats2\" title=\"nats2\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Fetcher splits the data into chunks of 100 objects and keeps a record of which chunks have not been processed. The application is designed so that the Fetcher can not be scaled.</p><p>The Fetcher subscribes to subject <em>mapper_status</em> and will wait for a Mapper to publish a message confirming that it's ready to process data. When the Fetcher receives this information, it publishes a chunk of data to subject <em>mapper_data</em> and starts again from the beginning.</p><p>As mentioned, when a mapper is ready to process more data, it publishes the info of availability to subject <em>mapper_status</em>. It also subscribes to subject <em>mapper_data</em>. When the Mapper gets a message, it processes it and publishes the processed data to subject <em>saver_data</em> and starts all over again. The subject <em>mapper_data</em> operates in <a href=\"https://docs.nats.io/nats-concepts/core-nats/queue\" target=\"_blank\" rel=\"noopener noreferrer\">queue</a> mode so each published message is received by only one Mapper.</p><p>The Saver subscribes to subject <em>saver_data</em>. Once receiving a message it saves it and publishes an acknowledgement message in the subject <em>processed_data</em>. The Fetcher subscribes to this subject and keeps track of what chunks of data have been saved. So even if any part of the application crashes all of the data will eventually be processed and saved. Also, the subject <em>saver_data</em> is used in queue mode so each chunk of processed data is taken care of only one Saver.</p><p>For simplicity, saving to a database and fetching from external API are omitted from our app.</p><p>Before deploying the app we shall use Helm to install NATS into our cluster. Instead of the Helm chart provided by the NATS team, we shall use the chart provided by <a href=\"https://bitnami.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Bitnami</a>.</p><p>The chart is <a href=\"https://artifacthub.io/packages/helm/bitnami/nats\" target=\"_blank\" rel=\"noopener noreferrer\">documentation</a> describe a set of\n<a href=\"https://artifacthub.io/packages/helm/bitnami/nats#parameters\" target=\"_blank\" rel=\"noopener noreferrer\">parameters</a> that can be used to modify the NATS configuration. Let us now disable the authentication by setting <em>auth.enabled</em> to value <em>false</em>.</p><p>Parameters can be set in the installation as follows:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ helm install --set auth.enabled=false my-nats oci://registry-1.docker.io/bitnamicharts/nats\n\n  NAME: my-nats\n  LAST DEPLOYED: Wed May  8 22:57:17 2024\n  NAMESPACE: default\n  STATUS: deployed\n  REVISION: 1\n  ...\n  NATS can be accessed via port 4222 on the following DNS name from within your cluster:\n\n   my-nats.default.svc.cluster.local\n\n  NATS monitoring service can be accessed via port 8222 on the following DNS name from within your cluster:\n\n    my-nats.default.svc.cluster.local\n\n  To access the Monitoring svc from outside the cluster, follow the steps below:\n\n  1. Get the NATS monitoring URL by running:\n\n      echo &quot;Monitoring URL: http://127.0.0.1:8222&quot;\n      kubectl port-forward --namespace default svc/my-nats 8222:8222\n\n  2. Open a browser and access the NATS monitoring browsing to the Monitoring URL\n  ...</code></pre></div><p>The installation prints many kinds of useful info for us.</p><p>We are now ready to deploy our <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app9\" target=\"_blank\" rel=\"noopener noreferrer\">app</a> that uses <a href=\"https://github.com/nats-io/nats.js\" target=\"_blank\" rel=\"noopener noreferrer\">nats.js</a> as the client library. Note that the example app uses nats.js version 1.5. The current version of the library has</p><p>The <strong>deployment.yaml</strong> that passes the connect URL <em>nats://my-nats:4222</em> to pods in env variable <em>NATS_URL</em> looks like the following:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mapper<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mapper\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> mapper\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mapper\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>mapper<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fetcher<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> fetcher\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> fetcher\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> fetcher\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>fetcher<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> saver<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> saver\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> saver\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> saver\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app9<span class=\"token punctuation\">-</span>saver<span class=\"token punctuation\">:</span>0bcd6794804c367684a9a79bb142bb4455096974\n          <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NATS_URL\n              <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> nats<span class=\"token punctuation\">:</span>//my<span class=\"token punctuation\">-</span>nats<span class=\"token punctuation\">:</span><span class=\"token number\">4222</span></code></pre></div><p>After applying the deployments we can confirm that everything works by reading the logs of the fetcher - <code class=\"language-text\">kubectl logs fetcher-dep-7d799bb6bf-zz8hr -f</code>:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Ready to send <span class=\"token comment\">#827</span>\nSent data <span class=\"token comment\">#827, 831 remaining</span>\nReady to send <span class=\"token comment\">#776</span>\nSent data <span class=\"token comment\">#776, 830 remaining</span>\nReady to send <span class=\"token comment\">#516</span>\nSent data <span class=\"token comment\">#516, 829 remaining</span>\nReady to send <span class=\"token comment\">#382</span>\nSent data <span class=\"token comment\">#382, 828 remaining</span>\nReady to send <span class=\"token comment\">#709</span>\n<span class=\"token punctuation\">..</span>.</code></pre></div><p>We'll want to monitor the state of NATS as well. NATS has a <a href=\"https://docs.nats.io/running-a-nats-service/nats_admin/monitoring\" target=\"_blank\" rel=\"noopener noreferrer\">web service</a> that provides many kinds of data for monitoring. We can access the service from the browser with <code class=\"language-text\">kubectl port-forward my-nats-0 8222:8222</code> in <a href=\"http://localhost:8222\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:8222</a>:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/1810905f8affaca4a4328e7f085c2a76/799f3/nats-stats.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9UlEQVQoz52QTUsDMRCG80/Fixevgnj0R3gSvAiehYpQeiqIIIKtWJTaarsfzbq72WTNMt1kkt3Y1rPV+MxcH953hiBqZ9BqJTlkCc/zYgl2Ca6qbCnV9iWstldh3Q3T6+C+Nx71bmd3L8Mx72Ywdc61q/kZMuJqt8/3+4ODm9O9i7Odo8vj85PO6+Fg0VnLbbNNNk37LJCCTkFklYySz0KWH+JdAne/QQwiSxIF4PwhSuP0LQjChTFm03N9ZbvhD7LSUUQpTbVG/2Sl4pjO55EQ5Xeyh1zXajKZMcatbbyTtV7Vjhlj/3kYgB0+FE+PJcvRt/YXRmt6wDDQwLgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/1810905f8affaca4a4328e7f085c2a76/a0b58/nats-stats.webp 230w,\n/static/1810905f8affaca4a4328e7f085c2a76/bc10c/nats-stats.webp 460w,\n/static/1810905f8affaca4a4328e7f085c2a76/966d8/nats-stats.webp 920w,\n/static/1810905f8affaca4a4328e7f085c2a76/445df/nats-stats.webp 1380w,\n/static/1810905f8affaca4a4328e7f085c2a76/ee7fd/nats-stats.webp 1642w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/1810905f8affaca4a4328e7f085c2a76/81c8e/nats-stats.png 230w,\n/static/1810905f8affaca4a4328e7f085c2a76/08a84/nats-stats.png 460w,\n/static/1810905f8affaca4a4328e7f085c2a76/c0255/nats-stats.png 920w,\n/static/1810905f8affaca4a4328e7f085c2a76/b1001/nats-stats.png 1380w,\n/static/1810905f8affaca4a4328e7f085c2a76/799f3/nats-stats.png 1642w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/1810905f8affaca4a4328e7f085c2a76/c0255/nats-stats.png\" alt=\"nats stats\" title=\"nats stats\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>We are already committed to using Prometheus for monitoring and for that, we need to do some configurations. Firstly we have to enable the <a href=\"https://github.com/nats-io/prometheus-nats-exporter\" target=\"_blank\" rel=\"noopener noreferrer\">Prometheus exporter</a>, which exposes the metrics to port 7777. From the Helm chart <a href=\"https://artifacthub.io/packages/helm/bitnami/nats#metrics-parameters\" target=\"_blank\" rel=\"noopener noreferrer\">documentation</a> we find out that <em>metrics.enabled</em> should be set to <em>true</em> to enable metrics.</p><p>The command <a href=\"https://helm.sh/docs/helm/helm_upgrade/\" target=\"_blank\" rel=\"noopener noreferrer\">helm upgrade</a> does the trick:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ helm upgrade --set metrics.enabled<span class=\"token operator\">=</span>true,auth.enabled<span class=\"token operator\">=</span>false my-nats oci://registry-1.docker.io/bitnamicharts/nats\n\n  <span class=\"token punctuation\">..</span>.\n  <span class=\"token number\">3</span>. Get the NATS Prometheus Metrics URL by running:\n\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Prometheus Metrics URL: http://127.0.0.1:7777/metrics\"</span>\n    kubectl port-forward --namespace default svc/my-nats-metrics <span class=\"token number\">7777</span>:7777\n\n  <span class=\"token number\">4</span>. Access NATS Prometheus metrics by opening the URL obtained <span class=\"token keyword\">in</span> a browser.</code></pre></div><p>The output already gives us instructions on how we can connect to the exported with the browser. Let us do it to ensure that everything works:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl port-forward --namespace default svc/my-nats-metrics <span class=\"token number\">7777</span>:7777</code></pre></div><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/02be38e535e6f15ad8e2e447228cbc71/913b9/nats-metrics.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.08695652173913%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkUlEQVQY04WNwQ6DIBBE/f9/wwSFgAc8QFo0oAGKDYVIu9pz7ctmM5d50+ScSynb9pzm9XY3elpn40PMxz1e/vIapZQQQkoJQR4o59y+7/mk1vr+TUMIQQj1fd91HWSMsTEmhLAsi/ceLFdlSmnbtuQEFOM4xhittV/Fn2XOOawxxiBAH/4wDKDQWsNySumi/AHXFRnCTkM/+AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/02be38e535e6f15ad8e2e447228cbc71/a0b58/nats-metrics.webp 230w,\n/static/02be38e535e6f15ad8e2e447228cbc71/bc10c/nats-metrics.webp 460w,\n/static/02be38e535e6f15ad8e2e447228cbc71/966d8/nats-metrics.webp 920w,\n/static/02be38e535e6f15ad8e2e447228cbc71/445df/nats-metrics.webp 1380w,\n/static/02be38e535e6f15ad8e2e447228cbc71/e3771/nats-metrics.webp 1822w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/02be38e535e6f15ad8e2e447228cbc71/81c8e/nats-metrics.png 230w,\n/static/02be38e535e6f15ad8e2e447228cbc71/08a84/nats-metrics.png 460w,\n/static/02be38e535e6f15ad8e2e447228cbc71/c0255/nats-metrics.png 920w,\n/static/02be38e535e6f15ad8e2e447228cbc71/b1001/nats-metrics.png 1380w,\n/static/02be38e535e6f15ad8e2e447228cbc71/913b9/nats-metrics.png 1822w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/02be38e535e6f15ad8e2e447228cbc71/c0255/nats-metrics.png\" alt=\"nats metrics\" title=\"nats metrics\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Connecting Prometheus to the exporter requires a new resource <a href=\"https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md\" target=\"_blank\" rel=\"noopener noreferrer\">ServiceMonitor</a>, which is another <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\" target=\"_blank\" rel=\"noopener noreferrer\">Custom Resource Definition</a> (CDR).</p><p>We could create the resource by ourselves but that is not needed since with a little more configuration, the Helm chart will do it for us. The following settings will create the ServiceMonitor:</p><p>Â´Â´Â´\nmetrics.serviceMonitor.enabled=true\nmetrics.serviceMonitor.namespace=prometheus\nÂ´Â´Â´</p><p>Since we are already setting value to quite many parameters, let us define those in a file:</p><p><strong>myvalues.yaml</strong></p><p>Â´Â´Â´yaml\nauth:\nenabled: false</p><p>metrics:\nenabled: true\nserviceMonitor:\nenabled: true\nnamespace: prometheus\nÂ´Â´Â´</p><p>Now we are ready to upgrade the chart:</p><p>Â´Â´Â´bash\nhelm upgrade -f myvalyes.yaml my-nats oci://registry-1.docker.io/bitnamicharts/nats\nÂ´Â´Â´</p><p>We can confirm that the ServiceMonitor <em>my-nats-metrics</em> is indeed created:</p><p>Â´Â´Â´bash\n$ kubectl get servicemonitors.monitoring.coreos.com -n prometheus\nNAME                                                        AGE\nkube-prometheus-stack-1714-alertmanager                     6d10h\nkube-prometheus-stack-1714-apiserver                        6d10h\nkube-prometheus-stack-1714-coredns                          6d10h\nkube-prometheus-stack-1714-kube-controller-manager          6d10h\nkube-prometheus-stack-1714-kube-etcd                        6d10h\nkube-prometheus-stack-1714-kube-proxy                       6d10h\nkube-prometheus-stack-1714-kube-scheduler                   6d10h\nkube-prometheus-stack-1714-kubelet                          6d10h\nkube-prometheus-stack-1714-operator                         6d10h\nkube-prometheus-stack-1714-prometheus                       6d10h\nkube-prometheus-stack-1714644114-grafana                    6d10h\nkube-prometheus-stack-1714644114-kube-state-metrics         6d10h\nkube-prometheus-stack-1714644114-prometheus-node-exporter   6d10h\nmy-nats-metrics                                             8m8s\nÂ´Â´Â´</p><p>We still need a suitable label for our configuration so that Prometheus knows to listen to the NATS.</p><p>Let's use the label that the already existing ServiceMonitors are using. We can check it with the following commands:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus get prometheus\n  NAME                                    VERSION   REPLICAS   AGE\n  kube-prometheus-stack-1714-prometheus   v2.51.2   1          39h\n\n$ kubectl describe prometheus -n prometheus kube-prometheus-stack-1714-prometheus\n...\n  Service Monitor Selector:\n    Match Labels:\n      Release:  kube-prometheus-stack-1714644114\n...</code></pre></div><p>So the label needs to be <em>release: kube-prometheus-stack-1714644114</em> unless we'd like to define a new Prometheus resource. Label is set as the value of <em>metrics.service.labels</em>.</p><p>Label can be attached to the ServiceMonitor with <a href=\"https://kubernetes.io/docs/reference/kubectl/generated/kubectl_label/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl label</a> command:</p><p>Â´Â´Â´bash\nkubectl label servicemonitors.monitoring.coreos.com -n prometheus my-nats-metrics release=kube-prometheus-stack-1714644114\nÂ´Â´Â´</p><p>Now Prometheus should have access to the new data. Let's check Prometheus:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 9090\nForwarding from 127.0.0.1:9090 -&gt; 9090\nForwarding from [::1]:9090 -&gt; 9090</code></pre></div><p>If all goes well, the NATS metrics ServiceMonitor is among the list of <em>targets</em>:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/8abe0816139a8d54397699ae423886d6/0ff19/nats-prome.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.43478260869565%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABYlAAAWJQFJUiTwAAABaUlEQVQY04WQS0vDQBSF8yMr2lZSrVYUXyAIbtwJggt/heBGxYUv0NpqXVTRtht15atNJs1Mps3MJBPbTDJOU7sTPHzcy+Wec2FGq9Ubj0+1yl315LyoOL24vrgslyv3pdvqv2hr6xvziysLS6u5/JyeL+jThcmp2WxuZjybG8voE1l9PKOn0n+j2ZgYdtewOwC5JnRBgoVcyyFq9dEmJiKMkqFcQigdDYRoOJAGlSaVgEmDSItJ5EuQjN1AFt9lw5JKUTyocRyHQsiRNBs6Du6IKOqFodoxn2AXyUiANvS/QxGJOFL+yOe81TIQcp5fXi2rzYNARTTToW/AbUH2aVOIvSYyv2DT6XqbZ3z5ONwp9SxMewHDGH9+NSGEAAB1gibSuO97jA5Rb1Ode56NaeFQpPZEel8c1PmL4TldxpVxoEH9DTPPdwkllCkoZW7SUIft3vS2rvrbxf5RI3h45208iKj/GkIT8w9jgY9RwiwG3QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/8abe0816139a8d54397699ae423886d6/a0b58/nats-prome.webp 230w,\n/static/8abe0816139a8d54397699ae423886d6/bc10c/nats-prome.webp 460w,\n/static/8abe0816139a8d54397699ae423886d6/966d8/nats-prome.webp 920w,\n/static/8abe0816139a8d54397699ae423886d6/445df/nats-prome.webp 1380w,\n/static/8abe0816139a8d54397699ae423886d6/78de1/nats-prome.webp 1840w,\n/static/8abe0816139a8d54397699ae423886d6/3c5e9/nats-prome.webp 2084w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/8abe0816139a8d54397699ae423886d6/81c8e/nats-prome.png 230w,\n/static/8abe0816139a8d54397699ae423886d6/08a84/nats-prome.png 460w,\n/static/8abe0816139a8d54397699ae423886d6/c0255/nats-prome.png 920w,\n/static/8abe0816139a8d54397699ae423886d6/b1001/nats-prome.png 1380w,\n/static/8abe0816139a8d54397699ae423886d6/161ec/nats-prome.png 1840w,\n/static/8abe0816139a8d54397699ae423886d6/0ff19/nats-prome.png 2084w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/8abe0816139a8d54397699ae423886d6/c0255/nats-prome.png\" alt=\"nats prome\" title=\"nats prome\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>We can now query the data:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/3a94ec2b72108834b13ccf8dae5a3b08/701e9/nats-prome2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 35.65217391304348%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYElEQVQY02WPzU7CQBSF+0yikRKkBsREFrBwwcZI4nu4NvEJfAU1MYDaApYfFSWBuHIhKoQCZUqhBLTttLSl4y2J0eiXk8zNyZw5c6m91EE0ltiJ74a3Y3QoEmCigc1ogNkKMJH1YHjFH1qlQ2t0yEfDwPhA/qB/I5xI7seTKeqCb9xUqqX7WrpYT+cqHH/L8ZUs/3DO3V3nS9lcMZMvn7LVDFdMs/xVoXSWe7wslBv1WvP5iZrp9nyJZjp4btu2QwhxCVmQH37PH9gWx+oxrx6yOmVgQ9P16Sc2AIwty/LCCwe0+MZ1HQDDFdOczmZdpJyUR0esRL23O5IsqxbRTa9zpExEJHl51yX/+GNSL68tcYBMAyuTiappnW6v+daCfvgH7GJ4ZaaxPEDggwmrLVyCzTkFviB0EZIQQoIgKIoyVpRWuy2KgwGS+v1+r9eTpKE8Gg1lWdd1VVUhD7Xw6BdcpVgMLxeUAAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/3a94ec2b72108834b13ccf8dae5a3b08/a0b58/nats-prome2.webp 230w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/bc10c/nats-prome2.webp 460w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/966d8/nats-prome2.webp 920w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/445df/nats-prome2.webp 1380w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/e11e5/nats-prome2.webp 1780w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/3a94ec2b72108834b13ccf8dae5a3b08/81c8e/nats-prome2.png 230w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/08a84/nats-prome2.png 460w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/c0255/nats-prome2.png 920w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/b1001/nats-prome2.png 1380w,\n/static/3a94ec2b72108834b13ccf8dae5a3b08/701e9/nats-prome2.png 1780w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/3a94ec2b72108834b13ccf8dae5a3b08/c0255/nats-prome2.png\" alt=\"nats prome2\" title=\"nats prome2\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Also the Prometheus API should return a result:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ curl http://localhost:9090/api/v1/query\\?query\\=gnatsd_connz_in_msgs\n  {\n    &quot;status&quot;:&quot;success&quot;,\n    &quot;data&quot;:{\n        &quot;resultType&quot;:&quot;vector&quot;,\n        &quot;result&quot;:[\n          {\n              &quot;metric&quot;:{\n                &quot;__name__&quot;:&quot;gnatsd_connz_in_msgs&quot;,\n                &quot;container&quot;:&quot;metrics&quot;,\n                &quot;endpoint&quot;:&quot;tcp-metrics&quot;,\n                &quot;instance&quot;:&quot;10.40.0.138:7777&quot;,\n                &quot;job&quot;:&quot;my-nats-metrics&quot;,\n                &quot;namespace&quot;:&quot;default&quot;,\n                &quot;pod&quot;:&quot;my-nats-0&quot;,\n                &quot;server_id&quot;:&quot;http://localhost:8222&quot;,\n                &quot;service&quot;:&quot;my-nats-metrics&quot;\n              },\n              &quot;value&quot;:[\n                1715203297.971,\n                &quot;1997&quot;\n              ]\n          }\n        ]\n    }\n  }</code></pre></div><p>If the result here is empty then something is wrong, the result may be a success even if the query doesn't make sense.</p><p>Now we just need to add a Grafana dashboard for the data. Let's import a dashboard from <a href=\"https://raw.githubusercontent.com/nats-io/prometheus-nats-exporter/5084a32850823b59069f21f3a7dde7e488fef1c6/walkthrough/grafana-nats-dash.json\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> instead of configuring our own.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus port-forward kube-prometheus-stack-1602180058-grafana-59cd48d794-4459m 3000</code></pre></div><p>Here we can paste the JSON using the \"Import dashboard\" and by choosing Prometheus as the source on the following page.</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/7c3ddafc2c33d33d2bb1a40e93098224/0faf1/grafana-import2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.08695652173913%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7ElEQVQY002Py07DMBBF/Q2QOPHbju24cSBpUYuAHeoXQ3k1iCSVoCAW7PkbJu0G6Wh0fDUz8qDn7dvd5uV+s314eu2Hj2HcT+w+gX7c98PBDyE833dfv+PP92MHfV3XIS4LoSwAQrkGuDBSOYCJgjAlNYie4BozuVIx6JAr63xESUoSTE+TqWa5OIJzDjXNGIQpZiA44ycJuQyL9fX6dn5DMc+oRLFezOK8aVdVbHMiCVVHwE0R6rOLUDXGBlfWQrvGn1/Vy2XZauUhRNZXhat8qEHgk/+QcIixM21KZUroUcbnXKdUArAIhv8AK7lLT9wOuCgAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/7c3ddafc2c33d33d2bb1a40e93098224/a0b58/grafana-import2.webp 230w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/bc10c/grafana-import2.webp 460w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/966d8/grafana-import2.webp 920w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/445df/grafana-import2.webp 1380w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/78de1/grafana-import2.webp 1840w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/8488f/grafana-import2.webp 1956w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/7c3ddafc2c33d33d2bb1a40e93098224/81c8e/grafana-import2.png 230w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/08a84/grafana-import2.png 460w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/c0255/grafana-import2.png 920w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/b1001/grafana-import2.png 1380w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/161ec/grafana-import2.png 1840w,\n/static/7c3ddafc2c33d33d2bb1a40e93098224/0faf1/grafana-import2.png 1956w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/7c3ddafc2c33d33d2bb1a40e93098224/c0255/grafana-import2.png\" alt=\"grafana import2\" title=\"grafana import2\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>And now we have a simple dashboard with data:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.39130434782609%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABXUlEQVQoz31Sx3bDMAzzPc1wbE1aXnFGm/7/76EEnbg99YAniaRAAlJVJCFJj8Oxxu7jgN3+iP3htO7/wYfW1ecWJ6Ju0bQBOXeoQu7RuICzBhoXDSF1aEOCi2mNac5i/vccpRhar2eFj9nIK04XlFnKiNwNKOOEbhwxLDOG24xumFCmGdJrXJG1jvvptmC6XxS6PhZcvu46lNcJE8kGpKwddR9tkoi6cTaJ085tEFMQkqg9xab1UayGcCHDp6JW1SSUTQ4vh45JUbJVuk96fvlMuSRyKSEWsTtE6nqtSwgiqFhAKZQ8P65YnjeVucoXXefPq0kqw2x1tGR53k0qm5CsV3uW7zv6y4SKXYv6RKlv2fSCJkf19q3A6SQhyussJpOPmZWUdxjzGjNCjm0eKYEV+ri9eN14i0VtxhpiJVvzjLcubbnq/U2YeCPk1fi/cTYLr9xW+/o6lM6VuR9BG+eLfbbg/AAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/a0b58/grafana-nats.webp 230w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/bc10c/grafana-nats.webp 460w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/966d8/grafana-nats.webp 920w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/445df/grafana-nats.webp 1380w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/78de1/grafana-nats.webp 1840w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/27d84/grafana-nats.webp 2056w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/81c8e/grafana-nats.png 230w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/08a84/grafana-nats.png 460w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png 920w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/b1001/grafana-nats.png 1380w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/161ec/grafana-nats.png 1840w,\n/static/9805594f4c1b4bdea7a35f4534b4f1e1/9e7e4/grafana-nats.png 2056w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/9805594f4c1b4bdea7a35f4534b4f1e1/c0255/grafana-nats.png\" alt=\"grafana nats\" title=\"grafana nats\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>This is now the final configuration:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 90.8695652173913%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAACmElEQVQ4y5VUS08aURS+2G278Je0a8If0HUb9y5NYzdtmpadC0xpXJjQJoY2RZJCdWjlIRQUCQGMxIUYNeALiIpEectbBG+/M5kxxBTBm5zMnXvO+c4335lzGbu3AoEA45yL+/Pz8+VOp8Nzudx1Pp+/pj3OXOSjmM3NTdZ3bW1t3QFWq1Uf9vzi4oJAacsrlYpfBozFYv0B/X7/HeDp6emncrkcBrAHzxWAbZycnHyWAcPhMBt4IUFBT5VK9dThcLy32+0flErlMzoDsGJgoNXV1TuGR0dHL0ul0tT+/v7cwcHBHHScOj4+fiUzDAaD/QFJaBnw6uoqSLpls1l+eXkpaogC6zLgzs7O4wCR7CCQYrHYAruWBOh8FGB3U9CAv6lUiu/u7tYikUgtnU7zs7Mzz4NNMRqNTBAEtrCwwBYXF5nP52Mej4f0U+zt7T1HgdGlpaVxxIyHQqHRaDT6AoUULpeLra2tiTndRpWG7pkC9qS7KBInvV7v63t/wdD/rOeng90YPlPvdrtnnE7nF7DWwWa2t7f1YDnWMxGaGCC0AaIbCoWCAQ2YR1f1OEtTE9Bpmg7R4OPSWRox3yiWcuRcMsYHWJgSXq/XBwnlxNCI6oZ4PP4H/9pPMJtHxR+Y3XkwEAAmYASX0W0H4gSwE+AXYygWc25KJBK/EUcMjT2l0Gg0wzab7Q26OWEymd6Zzea3Vqt1wmKxTGq12uGHNNTVarVZ/ApUVUeVk8nkCPkODw8/4t2MmF9gaYZuJtwwavKB1Qh833H2FbkGMJwFQx3r1qndbot7fO60dH2tS+9iU6Tra4N8AJqWc7v1pZujdXt724IeN41Goy7NrloaPbc0ek1o15T2K+TLZDJqem82m3WQuSEMsn8gdgt23IAbZgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/709982b7337c907e82909551fcb98e51/a0b58/app9-nats-prometheus-grafana.webp 230w,\n/static/709982b7337c907e82909551fcb98e51/24c94/app9-nats-prometheus-grafana.webp 441w\" sizes=\"(max-width: 441px) 100vw, 441px\" type=\"image/webp\">\n        <source srcset=\"/static/709982b7337c907e82909551fcb98e51/81c8e/app9-nats-prometheus-grafana.png 230w,\n/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png 441w\" sizes=\"(max-width: 441px) 100vw, 441px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/709982b7337c907e82909551fcb98e51/efc6e/app9-nats-prometheus-grafana.png\" alt=\"app9 nats prometheus grafana\" title=\"app9 nats prometheus grafana\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><exercise name='Exercise 4.06: Project v2.0'><p>  <em>If you use JavaScript, notice that the <a href=\"https://github.com/kubernetes-hy/material-example/tree/master/app9\" target=\"_blank\" rel=\"noopener noreferrer\">example app</a> uses nats.js library version 1.5. The <a href=\"https://www.npmjs.com/package/nats\" target=\"_blank\" rel=\"noopener noreferrer\">current version</a> of the library has significant changes in the API, so copy-pasting the code from the example will not work.</em></p><p>  Create a new separate service for sending status messages of the todos to a popular chat application. Let's call the new service \"broadcaster\".</p><p>  Requirements:</p><ol>\n<li>The backend saving or updating todos should send a message to NATS</li>\n<li>The broadcaster should subscribe to NATS messages</li>\n<li>The broadcaster should send the message forward to <strong>an external service</strong> in a format they support</li>\n</ol><p>  As the external service you can choose either:</p><ul>\n<li>Discord (you can use the course Full stack Discord, see <a href=\"https://fullstackopen.com/en/part11/expanding_further#exercise-11-18\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> for the details)</li>\n<li>Telegram</li>\n<li>Slack</li>\n</ul><p>  or if you don't want to use them, use \"Generic\" where a URL is set as an Environment variable and the payload is e.g.</p><div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bot\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"A todo was created\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div><p>  The broadcaster should be able to be scaled without sending the message multiple times. Test that it can run with 6 replicas without issues. The messages only have to be sent to the external service if all of the services are working correctly. So a randomly missing message is not an issue but a duplicate is.</p><p>  Example of a working broadcaster:\n<img src=\"/373b4b99e844fb5340312e7460d81ccf/ex406-solution.gif\"></p><p>  You should not write the API key in plain text.</p></exercise></div>","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"},"fileAbsolutePath":"/home/runner/work/kubernetes-hy.github.io/kubernetes-hy.github.io/data/part-4/2-messaging-systems.md"},"allPages":{"edges":[{"node":{"id":"e4e5fe1c-25b1-57b3-87eb-e204e767a49c","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"9f6e26aa-46a9-523d-96e4-a57c65ec083d","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"3d7eac33-2990-59d1-a002-64e0b0f4f370","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"57c61ed7-37c4-5d0f-acd8-1dca0de6be4a","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"fb4fb717-329a-5d49-94c3-183aa16507e2","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"ecaa7011-87db-5ece-9b3c-1cfad638324a","frontmatter":{"path":"/","title":"Homepage"}}},{"node":{"id":"8ecc11b1-3298-589e-b97a-2a3a36861b8d","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"dab4b6a7-96cf-5efe-83f4-f5199c283e65","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"78948204-39a7-5f81-b9f4-3029400d5f82","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"19841be9-897c-577a-9f82-5a7381bc073c","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"fe4a80ee-85ba-536e-bbf5-c5695399f40f","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"0b237cfb-5f2a-5d8e-9aa0-0cf9b045db3a","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"9e4ff8d0-2e6c-5d55-83a0-16ada460096d","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"56f2a7a2-c9e2-5bbb-b6a7-76fd46592c69","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"f802a4ea-8d5a-503f-ad7b-d0138ab84c80","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"b810e0d9-0ac2-5073-a9dc-4ffd6649b7f7","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"40440141-c1a8-5723-858a-eea86119b5b6","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"708df9d2-30d1-518f-8066-80109a75c4dc","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"47a288aa-ece4-5ba6-ab6e-cbc63dbdc752","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"c8b1eb5e-3c98-59b3-b6e9-6173791d7e34","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"8a2e40fa-1703-5755-aa66-ac69bf2e291d","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"7bebb01b-c990-5e7e-a9aa-d60f10ba63dd","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"e4c53dca-867f-5293-9b28-657b695cd3f3","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"fd6ebeaa-c808-5f11-9bdc-30e4f69b8a2a","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"0353d158-f751-57fd-94ce-373924da1b05","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"eae6660d-1d18-527a-bc1c-0f2f7ab54c6d","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"9f3c6f02-668a-517b-b7b6-1828f74c7200","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"e80b74e8-a23b-5d3c-808b-833a72ac739c","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"78f84327-bd7b-5b5d-941d-9fae8bca88d3","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"0a2d8cfd-8e40-59a7-a688-e8bdc9fb9e3a","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"39fb03b7-2abe-515a-a543-b812fcbfdba5","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"a899eeb2-4329-5c9b-aadf-2fb803fa9142","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"471982cb-da12-5799-a6b2-fa8a3e67aa0d","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"cbd58376-8d52-5297-b38d-653179a1226f","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"33c86b5c-3684-5006-b4e7-dbd0c7cc04bc","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}},{"node":{"id":"f5314214-d779-5fb4-a19f-ab7442f3fbb2","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"da15a80e-5316-5986-afcf-75d521065017","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}