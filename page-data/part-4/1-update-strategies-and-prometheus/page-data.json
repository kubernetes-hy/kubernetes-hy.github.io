{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-4/1-update-strategies-and-prometheus","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"Learning Objectives"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After this section, you can"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Compare update strategies"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Confidently"}]},{"type":"text","value":" deploy software with canary releases"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Use Prometheus for custom queries"}]},{"type":"text","value":"\n"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the previous part, we did automated updates with a deployment pipeline. The update "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"just worked"}]},{"type":"text","value":", but we have no idea how the update actually happened, other than that a pod was changed. Let us now look how we can make the update process safer to help us reach a higher number of "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/High_availability","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"nines"}]},{"type":"text","value":" in the availability."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There are multiple update/deployment/release strategies. We will focus on two of them:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Rolling update"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Canary release"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Both of these update strategies are designed to make sure that the application works during and after an update. Rather than updating every pod at the same time, the idea is to update the pods one at a time and confirm that the application works."}]},{"type":"element","tagName":"h3","properties":{"id":"rolling-update","style":"position:relative;"},"children":[{"type":"text","value":"Rolling update"},{"type":"element","tagName":"a","properties":{"href":"#rolling-update","ariaLabel":"rolling update permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"By default, Kubernetes initiates a "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/management/#updating-your-application-without-an-outage","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"rolling update"}]},{"type":"text","value":" when we change the image. That means that every pod is updated sequentially. The rolling update is a great default since it enables the application to be available during the update. If we decide to push an image that does not work, the update will automatically stop."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"I've prepared an application with 5 versions here. The one with tag v1 works always, v2 never works, v3 works 90% of the time, v4 will die after 20 seconds and v5 works always."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1"}]}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep created\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-7b5fd9ffc7-27cxt   1/1     Running   0          87s\n  flaky-update-dep-7b5fd9ffc7-mp8vd   1/1     Running   0          88s\n  flaky-update-dep-7b5fd9ffc7-m4smm   1/1     Running   0          87s\n  flaky-update-dep-7b5fd9ffc7-nzl98   1/1     Running   0          88s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now change the tag to v2 and apply it."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n$ kubectl get po --watch\n..."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can see the rolling update performed but unfortunately, the application no longer works. The application is running, it's just that there's a bug that prevents it from working correctly. How do we communicate this malfunction outside the application? This is where "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbes"}]}]},{"type":"text","value":" come in."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Kubernetes Best Practices - Kubernetes Health Checks with Readiness and Liveness Probes"}]}]},{"type":"element","tagName":"iframe","properties":{"width":560,"height":315,"src":"https://www.youtube-nocookie.com/embed/mxEvAPQRwhw","frameBorder":"0","allow":"accelerometer; encrypted-media; gyroscope; picture-in-picture","allowFullScreen":true},"children":[]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With a "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbe"}]},{"type":"text","value":" Kubernetes can check if a pod is ready to process requests. The application has an endpoint "},{"type":"element","tagName":"a","properties":{"href":"https://stackoverflow.com/questions/43380939/where-does-the-convention-of-using-healthz-for-application-health-checks-come-f","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"/healthz"}]},{"type":"text","value":" in port 3541, and we can use that to test for health. It will simply answer with status code 500 if it's not working and 200 if it is."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's roll the version back to v1 as well, so we can test the update to v2 again."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Initial delay until the readiness is tested"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# How often to test"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"text","value":" and "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"text","value":" will mean that the probe is sent 10 seconds after the container is up and every 5 seconds after that. Now if we change the tag to v2 and apply it, the result will look like this:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-f5c79dbc-8lnqm     1/1     Running   0          115s\n  flaky-update-dep-f5c79dbc-86fmd     1/1     Running   0          116s\n  flaky-update-dep-f5c79dbc-qzs9p     1/1     Running   0          98s\n  flaky-update-dep-54888b877b-dkctl   0/1     Running   0          25s\n  flaky-update-dep-54888b877b-dbw29   0/1     Running   0          24s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here three of the pods are completely functional, one of v1 was dropped to make way for the v2 ones, but since they do not work, they are never READY and the update can not continue."}]},{"type":"element","tagName":"h3","properties":{"id":"gke-ingress-and-pod-readiness","style":"position:relative;"},"children":[{"type":"text","value":"GKE ingress and pod readiness"},{"type":"element","tagName":"a","properties":{"href":"#gke-ingress-and-pod-readiness","ariaLabel":"gke ingress and pod readiness permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If you are using Ingress in your app, you should note that the ReadinessProbe does not work quite like one would expect, requests get also routed to pods that are not "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ready"}]},{"type":"text","value":". The documentation "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#interpreted_hc","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"recommends"}]},{"type":"text","value":" the following:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"If serving Pods for your Service contain multiple containers, or if you're using the GKE Enterprise Ingress controller, you should use a BackendConfig CRD to define health check parameters."}]},{"type":"text","value":" So if you want to use the GKE default ingress, "},{"type":"element","tagName":"a","properties":{"href":"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#direct_hc_instead","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"BackendConfig"}]},{"type":"text","value":" should be defined. Instead of using a provider-specific Ingress, the\nbetter option is to use e.g. "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/kubernetes/ingress-nginx/tree/main","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ingress-nginx"}]},{"type":"text","value":" that happens similarly no matter where it is run."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Using "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ingress-nginx"}]},{"type":"text","value":" is easy. First, it needs to be installed by running the following commands:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ helm repo "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"add"}]},{"type":"text","value":" ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm repo update\n$ helm "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"install"}]},{"type":"text","value":" nginx-ingress ingress-nginx/ingress-nginx"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/#IngressSpec","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"ingress spec"}]},{"type":"text","value":" the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ingressClassName"}]},{"type":"text","value":" specifies the Ingress controller that is used:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" networking.k8s.io/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ping"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"pong"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ingressClassName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# this is added"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"http"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# rules are here"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The available ingress controllers (besides the default) can be checked with "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"kubectl"}]},{"type":"text","value":" as follows:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ kubectl get IngressClass\nNAME    CONTROLLER             PARAMETERS   AGE\nnginx   k8s.io/ingress-nginx   "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"none"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":"       3h38m"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There is a lesson to learn:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 31.304347826086953%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQY01VQWw6DIBDs/S/S9MekvY2JIhQEVHwCyofaDto07QYmsxtmd5bLI7nek5sQsiCk7/txHJdlCSHM87yu6+s/9n3/TS9KScZoVVVaa6WUEAJESlmWZdM0Xde1bftFdDeNqevaORfFuMMwpGmaZVlRFHmeM8ayIwghqDCKAnsewTk/kT+59z6KrbWYqSuNliAYi+FIwY0xYQlYBE/dEdZZbASCpT7i8ghMgDE/+3i+r62dpulE/MiJqG/bFsVI4BBeKKVATFbRgEI7cFRAojWtQdAdyvPn3lBCTKn6t4HHAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/5e58e3883a2af493d0d9ea7491b7c97e/a0b58/jami-ingress.webp 230w","/static/5e58e3883a2af493d0d9ea7491b7c97e/bc10c/jami-ingress.webp 460w","/static/5e58e3883a2af493d0d9ea7491b7c97e/966d8/jami-ingress.webp 920w","/static/5e58e3883a2af493d0d9ea7491b7c97e/445df/jami-ingress.webp 1380w","/static/5e58e3883a2af493d0d9ea7491b7c97e/31418/jami-ingress.webp 1740w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/5e58e3883a2af493d0d9ea7491b7c97e/81c8e/jami-ingress.png 230w","/static/5e58e3883a2af493d0d9ea7491b7c97e/08a84/jami-ingress.png 460w","/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png 920w","/static/5e58e3883a2af493d0d9ea7491b7c97e/b1001/jami-ingress.png 1380w","/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png 1740w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png","alt":"jami ingress","title":"jami ingress","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.01: Readiness Probe"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Create a ReadinessProbe for the Ping-pong application. It should be ready when it has a connection to the database."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  And another ReadinessProbe for Log output application. It should be ready when it can receive data from the Ping-pong application."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Test that it works by applying everything but the database statefulset. The output of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl get po"}]},{"type":"text","value":" should look like this before the database is available:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"NAME                             READY   STATUS    RESTARTS   AGE\nlogoutput-dep-7f49547cf4-ttj4f   1/2     Running   0          21s\npingpong-dep-9b698d6fb-jdgq9     0/1     Running   0          21s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Adding the database should automatically move the READY states to 2/2 and 1/1 for Log output and Ping-pong respectively."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Even though v2 didn't work, at least the application is working. We can just push a new update on top of the v2. Let's try the v4 which should break after a short while:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the ReadinessProbe may pass for the first 20 seconds, but soon enough every pod will break. Unfortunately "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbe"}]},{"type":"text","value":" cannot do anything about it, the deployment was successful but the application is buggy."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl get po\n  NAME                               READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-dd78944f4-vv27w   0/1     Running   0          111s\n  flaky-update-dep-dd78944f4-dnmcg   0/1     Running   0          110s\n  flaky-update-dep-dd78944f4-zlh4v   0/1     Running   0          92s\n  flaky-update-dep-dd78944f4-zczmw   0/1     Running   0          90s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's roll back to the previous version. This may come in handy, if you ever are in a panic mode and need to roll an update back:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl rollout undo deployment flaky-update-dep\n  deployment.apps/flaky-update-dep rolled back"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This will roll back into the previous version. Since it was v2, which doesn't work, we need to use a flag with the undo:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl describe deployment flaky-update-dep | grep Image\n    Image:        jakousa/dwk-app8:v2\n\n$ kubectl rollout undo deployment flaky-update-dep --to-revision=1\n  deployment.apps/flaky-update-dep rolled back\n\n$ kubectl describe deployment flaky-update-dep | grep Image\n    Image:        jakousa/dwk-app8:v1"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Read "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"kubectl rollout undo --help"}]},{"type":"text","value":" to find out more!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There's another probe that could've helped us in a situation like the v4. "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"LivenessProbes"}]}]},{"type":"text","value":" can be configured similarly to "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"ReadinessProbes"}]},{"type":"text","value":", but if the check fails the container will be restarted."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"deployment.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" apps/v1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Deployment\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Initial delay until the readiness is tested"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# How often to test"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"livenessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Initial delay until the liveness is tested"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# How often to test"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With this let's just deploy the worst of the versions, v3."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After a while, it may look something like this (if you're lucky)."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-fd65cd468-4vgwx   1/1     Running   3          2m30s\n  flaky-update-dep-fd65cd468-9h877   0/1     Running   4          2m49s\n  flaky-update-dep-fd65cd468-jpz2m   0/1     Running   3          2m13s\n  flaky-update-dep-fd65cd468-529nr   1/1     Running   4          2m50s"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"At least something is working!"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If your app is slow to start, a "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"StartupProbe"}]},{"type":"text","value":" can be used to delay the liveness probe and prevent it from firing prematurely. You may require it in real life but is not discussed further in this course."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.02: Project v1.7"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Create the required probes and endpoint for The Project to ensure that it's working and connected to a database."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Test that the probe indeed works with a version without database access, for example by supplying a wrong database URL or credentials."}]}]},{"type":"element","tagName":"h3","properties":{"id":"canary-release","style":"position:relative;"},"children":[{"type":"text","value":"Canary release"},{"type":"element","tagName":"a","properties":{"href":"#canary-release","ariaLabel":"canary release permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With rolling updates, when including the Probes, we could create releases with no downtime for users. Sometimes this is not enough and you need to be able to do a "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"partial release"}]},{"type":"text","value":" for some users and get data for the upcoming release. "},{"type":"element","tagName":"a","properties":{"href":"https://martinfowler.com/bliki/CanaryRelease.html","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Canary release"}]},{"type":"text","value":" is the term used to describe a release strategy in which we introduce a subset of the users to a new version of the application. When the confidence in the new release grows, the number of users in the new version can be increased until the old version is no longer used."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"At the moment of writing this, Canary is not a strategy for deployments that Kubernetes would provide out of the box. This may be due to the ambiguity of the methods for canary release. We will use "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Argo Rollouts"}]},{"type":"text","value":" to test one type of canary release:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl create namespace argo-rollouts\n$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we have a new resource "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/migrating/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Rollout"}]},{"type":"text","value":" available to us. The Rollout will replace our previously created deployment and enable us to use a new field:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"rollout.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" argoproj.io/v1alpha1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Rollout\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dep\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"replicas"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"4"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"selector"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"matchLabels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"strategy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"canary"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"25"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pause"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"duration"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 30s\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"50"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pause"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"duration"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 30s\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"template"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"labels"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"app"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"containers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" flaky"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"update\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jakousa/dwk"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"app8"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"v1\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"readinessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"10"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Initial delay until the readiness is tested"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# How often to test"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"livenessProbe"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelaySeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"20"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Initial delay until the liveness is tested"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"periodSeconds"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"5"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# How often to test"}]},{"type":"text","value":"\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"httpGet"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /healthz\n               "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"port"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3541"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The above strategy will first move 25% ("},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/canary/#overview","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"setWeight"}]}]},{"type":"text","value":") of the pods to a new version (in our case 1 pod) after which it will wait for 30 seconds, move to 50% of pods and then wait for 30 seconds until every pod is updated. The "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"kubectl plugin"}]},{"type":"text","value":" from Argo also offers us "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_promote/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"promote"}]},{"type":"text","value":" command to enable us to pause the rollout indefinitely and then use the promote to move forward."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There are other options such as the "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/bluegreen/#maxunavailable","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"maxUnavailable"}]}]},{"type":"text","value":" but the defaults will work for us. However, simply rolling slowly to production will not be enough for a canary deployment. Just like with rolling updates "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"we need to know the status of the application"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With another custom resource we've already installed with Argo Rollouts called "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"AnalysisTemplate"}]},{"type":"text","value":" we will be able to define a test that doesn't let the broken versions through."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let us extend our rollout with an analysis:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"strategy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"canary"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"steps"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"setWeight"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"50"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"analysis"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"templates"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"templateName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"..."}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The analysis will be using a template called "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"restart-rate"}]},{"type":"text","value":". Next, we have to define how the analysis will be done. For that, we shall need Prometheus which we briefly used in "},{"type":"element","tagName":"a","properties":{"href":"/part-2/5-monitoring"},"children":[{"type":"text","value":"part 2"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.03: Prometheus"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Ok, we started up Prometheus in part 2, but we have barely scratched the surface. Let's do a single hands-on query to learn more."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Start now Prometheus with Helm and use port-forward to access the GUI website. Port 9090 is the default for Prometheus:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ kubectl -n prometheus get pods\n NAME                                                              READY   STATUS    RESTARTS   AGE\n  alertmanager-kube-prometheus-stack-1714-alertmanager-0            2/2     Running   0          3h19m\n  kube-prometheus-stack-1714-operator-94c596dbd-n5pcl               1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-grafana-54cbbc4c46-m26f6         3/3     Running   0          3h19m\n  kube-prometheus-stack-1714644114-kube-state-metrics-7cb796tpjbd   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-kdpln   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-sp9pg   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-vbbjk   1/1     Running   0          3h19m\n  prometheus-kube-prometheus-stack-1714-prometheus-0                2/2     Running   0          3h19m\n\n$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 9090:9090\n  Forwarding from 127.0.0.1:9090 -> 9090\n  Forwarding from [::1]:9090 -> 9090"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  And now accessing "},{"type":"element","tagName":"a","properties":{"href":"http://localhost:9090","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"http://localhost:9090"}]},{"type":"text","value":" will allow us to write queries."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Write a query"}]},{"type":"text","value":" that shows the number of pods created by StatefulSets in "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"prometheus"}]},{"type":"text","value":" namespace. For the above setup the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Value"}]},{"type":"text","value":" should be 3 different pods:"}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 29.130434782608695%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3UlEQVQY032NbUoEMQyGexnP5w08jb+8hogHUBDRH4vM7M7uNP1M25m2aezuIIqgDyEkD7y8QmutbBhMNT5aTBrXUReLsb/Kp9FU5SJYBLcOumBIpVJjdolSIQHWgjyBVFpKM01eqSAhGoPauNPsQXkJYZZOm0ztTcF4PNw/TVc3u+u7WSxrtrERUWvEzP1qVC+bqNY+m+nfsqxH55Q1w+xvH+HhHQUobUP2IZZSnl9e15z5D3qeW+P2bQQi9s6erLV+DPtcyrn/wtbdvjj7H9FuBP/LlvlFzDwjp8yfyXxZomT2YzcAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9295ed50207655f31d8c229e0e61375b/a0b58/prometheus-p4.webp 230w","/static/9295ed50207655f31d8c229e0e61375b/bc10c/prometheus-p4.webp 460w","/static/9295ed50207655f31d8c229e0e61375b/966d8/prometheus-p4.webp 920w","/static/9295ed50207655f31d8c229e0e61375b/445df/prometheus-p4.webp 1380w","/static/9295ed50207655f31d8c229e0e61375b/78de1/prometheus-p4.webp 1840w","/static/9295ed50207655f31d8c229e0e61375b/3c376/prometheus-p4.webp 1998w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/9295ed50207655f31d8c229e0e61375b/81c8e/prometheus-p4.png 230w","/static/9295ed50207655f31d8c229e0e61375b/08a84/prometheus-p4.png 460w","/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png 920w","/static/9295ed50207655f31d8c229e0e61375b/b1001/prometheus-p4.png 1380w","/static/9295ed50207655f31d8c229e0e61375b/161ec/prometheus-p4.png 1840w","/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png 1998w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png","alt":"prometheus p4","title":"prometheus p4","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Query for \"kube_pod_info\" should have the required fields to filter through. See "},{"type":"element","tagName":"a","properties":{"href":"https://prometheus.io/docs/prometheus/latest/querying/basics/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"documentation"}]},{"type":"text","value":" for help with querying."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The AnalysisTemplate will, in our case, use Prometheus to query the state of the deployment. The query result is then compared to a preset value. In this simplified case, if the number of overall restarts over the last 2 minutes is higher than two, it will fail the analysis. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"initialDelay"}]},{"type":"text","value":" will ensure that the test is not run until the data required is gathered. The template looks as follows:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"analysistemplate.yaml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" argoproj.io/v1alpha1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" AnalysisTemplate\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metrics"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" restart"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"rate\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"initialDelay"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 2m\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"successCondition"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" result < 2\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"provider"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"prometheus"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"address"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" http"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//kube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"prometheus"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"stack"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"1602"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"prometheus.prometheus.svc.cluster.local"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"9090"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# DNS name for my Prometheus, find yours with kubectl describe svc ..."}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"query"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"|"}]},{"type":"element","tagName":"span","properties":{"className":["token","scalar","string"]},"children":[{"type":"text","value":"\n          scalar(\n            sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"}) -\n            sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"} offset 2m)\n          )"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With the new Rollout and AnalysisTemplate, we can safely try to deploy any version. Deploy for v2 is prevented with the Probes we set up. Deploy for v3 will automatically roll back when it notices that it has random crashes. The v4 will also eventually fail, but the short 2 minutes to test may still let a version get deployed."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The Argo Rollouts "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"kubectl plugin"}]},{"type":"text","value":" allows you to visualize the Rollout and its related resources. To watch the Rollout as it deploys, we can run it in watch mode:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"kubectl argo rollouts get rollout flaky-update-dep --watch"}]}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;"},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAABDklEQVQoz41S25KDIAwF5CIKyqWAo6h1pvv/v7in25dudx/IIEMkycnJgWzbxjkXQtRac85SSkIIY4y02HVdfd8LIdd1nedZKQV3GIamZKDFGBGttYZLGSVApU25JITwylyWBYV88CZyIdvaLqVYayml4El/rMPXBvxs23vfdV3rkN7NOYeeOZfveJgZykECXGGH+1LhL+eYUpgnDWDOnwtmzIhBQMBpmnAAL87/o4I7zHuv5TzW6759Pa4YbzknM5re9HWv0M5aU7Kz9lnxF7vJWhfT6G5ynJR12gQ8GQQZY6A5lMcTQs9Mctaxz1EiwmeXz1TOvD2W9SyAhWz4r0a1HzsIH8eRatKD/uj6G1OTEKJqQgCjAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"picture","properties":{},"children":[{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/05739caf16d8b8b3e0410e1ac9814510/a0b58/rollout.webp 230w","/static/05739caf16d8b8b3e0410e1ac9814510/bc10c/rollout.webp 460w","/static/05739caf16d8b8b3e0410e1ac9814510/966d8/rollout.webp 920w","/static/05739caf16d8b8b3e0410e1ac9814510/445df/rollout.webp 1380w","/static/05739caf16d8b8b3e0410e1ac9814510/331b9/rollout.webp 1748w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/webp"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"source","properties":{"srcSet":["/static/05739caf16d8b8b3e0410e1ac9814510/81c8e/rollout.png 230w","/static/05739caf16d8b8b3e0410e1ac9814510/08a84/rollout.png 460w","/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png 920w","/static/05739caf16d8b8b3e0410e1ac9814510/b1001/rollout.png 1380w","/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png 1748w"],"sizes":["(max-width:","920px)","100vw,","920px"],"type":"image/png"},"children":[]},{"type":"text","value":"\n        "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"src":"/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png","alt":"rollout","title":"rollout","loading":"lazy","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"},"children":[]},{"type":"text","value":"\n      "}]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Besides the pods, we see here also "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"AnalysisRun"}]},{"type":"text","value":" that is the instance of the test being run. You might also want to try Argo Rollouts "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/dashboard/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"dashboard"}]},{"type":"text","value":", which gives even fancier visualization of the state of your rollouts."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In general, the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"AnalysisTemplate"}]},{"type":"text","value":" is not dependent on Prometheus and could use a different source, such as a JSON endpoint, instead."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.04: Project v1.8"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Create an AnalysisTemplate for The Project that will follow the CPU usage of all containers in the namespace."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  If the CPU usage "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"rate"}]},{"type":"text","value":" sum for the namespace increases above a set value (you may choose a good hardcoded value for your project) within 10 minutes, revert the update."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Make sure that the application doesn't get updated, if the value is set too low."}]}]},{"type":"element","tagName":"h3","properties":{"id":"other-deployment-strategies","style":"position:relative;"},"children":[{"type":"text","value":"Other deployment strategies"},{"type":"element","tagName":"a","properties":{"href":"#other-deployment-strategies","ariaLabel":"other deployment strategies permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kubernetes supports "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#recreate-deployment","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Recreate"}]},{"type":"text","value":" strategy which takes down the previous pods and replaces everything with the updated one. This creates a moment of downtime for the application but ensures that different versions are not running at the same time. Argo Rollouts supports "},{"type":"element","tagName":"a","properties":{"href":"https://argoproj.github.io/argo-rollouts/features/bluegreen/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"BlueGreen"}]},{"type":"text","value":" strategy, in which a new version is run side by side to the new one, but traffic is switched between the two at a certain point, such as after running update scripts or after your QA team has approved the new version."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 4.05: Project v1.9"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"  Speaking of updating.\nOur todo application could use \"Done\" field for todos that are already done.\nIt should be a PUT request to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/todos/<id>"}]},{"type":"text","value":"."}]}]}]},"html":"<div><text-box variant='learningObjectives' name='Learning Objectives'><p>After this section, you can</p><ul>\n<li>Compare update strategies</li>\n<li><strong>Confidently</strong> deploy software with canary releases</li>\n<li>Use Prometheus for custom queries</li>\n</ul></text-box><p>In the previous part, we did automated updates with a deployment pipeline. The update <em>just worked</em>, but we have no idea how the update actually happened, other than that a pod was changed. Let us now look how we can make the update process safer to help us reach a higher number of <a href=\"https://en.wikipedia.org/wiki/High_availability\" target=\"_blank\" rel=\"noopener noreferrer\">nines</a> in the availability.</p><p>There are multiple update/deployment/release strategies. We will focus on two of them:</p><ul>\n<li>Rolling update</li>\n<li>Canary release</li>\n</ul><p>Both of these update strategies are designed to make sure that the application works during and after an update. Rather than updating every pod at the same time, the idea is to update the pods one at a time and confirm that the application works.</p><h3 id=\"rolling-update\" style=\"position:relative;\">Rolling update<a href=\"#rolling-update\" aria-label=\"rolling update permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>By default, Kubernetes initiates a <a href=\"https://kubernetes.io/docs/concepts/workloads/management/#updating-your-application-without-an-outage\" target=\"_blank\" rel=\"noopener noreferrer\">rolling update</a> when we change the image. That means that every pod is updated sequentially. The rolling update is a great default since it enables the application to be available during the update. If we decide to push an image that does not work, the update will automatically stop.</p><p>I've prepared an application with 5 versions here. The one with tag v1 works always, v2 never works, v3 works 90% of the time, v4 will die after 20 seconds and v5 works always.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1</code></pre></div><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep created\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-7b5fd9ffc7-27cxt   1/1     Running   0          87s\n  flaky-update-dep-7b5fd9ffc7-mp8vd   1/1     Running   0          88s\n  flaky-update-dep-7b5fd9ffc7-m4smm   1/1     Running   0          87s\n  flaky-update-dep-7b5fd9ffc7-nzl98   1/1     Running   0          88s</code></pre></div><p>Now change the tag to v2 and apply it.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f deployment.yaml\n$ kubectl get po --watch\n...</code></pre></div><p>You can see the rolling update performed but unfortunately, the application no longer works. The application is running, it's just that there's a bug that prevents it from working correctly. How do we communicate this malfunction outside the application? This is where <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes\" target=\"_blank\" rel=\"noopener noreferrer\"><em>ReadinessProbes</em></a> come in.</p><p><strong>Kubernetes Best Practices - Kubernetes Health Checks with Readiness and Liveness Probes</strong></p><iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/mxEvAPQRwhw\" frameborder=\"0\" allow=\"accelerometer; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe><p>With a <em>ReadinessProbe</em> Kubernetes can check if a pod is ready to process requests. The application has an endpoint <a href=\"https://stackoverflow.com/questions/43380939/where-does-the-convention-of-using-healthz-for-application-health-checks-come-f\" target=\"_blank\" rel=\"noopener noreferrer\">/healthz</a> in port 3541, and we can use that to test for health. It will simply answer with status code 500 if it's not working and 200 if it is.</p><p>Let's roll the version back to v1 as well, so we can test the update to v2 again.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Initial delay until the readiness is tested</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># How often to test</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n               <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>Here the <em>initialDelaySeconds</em> and <em>periodSeconds</em> will mean that the probe is sent 10 seconds after the container is up and every 5 seconds after that. Now if we change the tag to v2 and apply it, the result will look like this:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured\n\n$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-f5c79dbc-8lnqm     1/1     Running   0          115s\n  flaky-update-dep-f5c79dbc-86fmd     1/1     Running   0          116s\n  flaky-update-dep-f5c79dbc-qzs9p     1/1     Running   0          98s\n  flaky-update-dep-54888b877b-dkctl   0/1     Running   0          25s\n  flaky-update-dep-54888b877b-dbw29   0/1     Running   0          24s</code></pre></div><p>Here three of the pods are completely functional, one of v1 was dropped to make way for the v2 ones, but since they do not work, they are never READY and the update can not continue.</p><h3 id=\"gke-ingress-and-pod-readiness\" style=\"position:relative;\">GKE ingress and pod readiness<a href=\"#gke-ingress-and-pod-readiness\" aria-label=\"gke ingress and pod readiness permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>If you are using Ingress in your app, you should note that the ReadinessProbe does not work quite like one would expect, requests get also routed to pods that are not <em>ready</em>. The documentation <a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#interpreted_hc\" target=\"_blank\" rel=\"noopener noreferrer\">recommends</a> the following:</p><p><em>If serving Pods for your Service contain multiple containers, or if you're using the GKE Enterprise Ingress controller, you should use a BackendConfig CRD to define health check parameters.</em> So if you want to use the GKE default ingress, <a href=\"https://cloud.google.com/kubernetes-engine/docs/concepts/ingress#direct_hc_instead\" target=\"_blank\" rel=\"noopener noreferrer\">BackendConfig</a> should be defined. Instead of using a provider-specific Ingress, the\nbetter option is to use e.g. <a href=\"https://github.com/kubernetes/ingress-nginx/tree/main\" target=\"_blank\" rel=\"noopener noreferrer\">ingress-nginx</a> that happens similarly no matter where it is run.</p><p>Using <em>ingress-nginx</em> is easy. First, it needs to be installed by running the following commands:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ helm repo <span class=\"token function\">add</span> ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm repo update\n$ helm <span class=\"token function\">install</span> nginx-ingress ingress-nginx/ingress-nginx</code></pre></div><p>In the <a href=\"https://kubernetes.io/docs/reference/kubernetes-api/service-resources/ingress-v1/#IngressSpec\" target=\"_blank\" rel=\"noopener noreferrer\">ingress spec</a> the <em>ingressClassName</em> specifies the Ingress controller that is used:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ping<span class=\"token punctuation\">-</span>pong<span class=\"token punctuation\">-</span>ingress\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> nginx <span class=\"token comment\"># this is added</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># rules are here</span></code></pre></div><p>The available ingress controllers (besides the default) can be checked with <em>kubectl</em> as follows:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl get IngressClass\nNAME    CONTROLLER             PARAMETERS   AGE\nnginx   k8s.io/ingress-nginx   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>       3h38m</code></pre></div><p>There is a lesson to learn:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 31.304347826086953%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQY01VQWw6DIBDs/S/S9MekvY2JIhQEVHwCyofaDto07QYmsxtmd5bLI7nek5sQsiCk7/txHJdlCSHM87yu6+s/9n3/TS9KScZoVVVaa6WUEAJESlmWZdM0Xde1bftFdDeNqevaORfFuMMwpGmaZVlRFHmeM8ayIwghqDCKAnsewTk/kT+59z6KrbWYqSuNliAYi+FIwY0xYQlYBE/dEdZZbASCpT7i8ghMgDE/+3i+r62dpulE/MiJqG/bFsVI4BBeKKVATFbRgEI7cFRAojWtQdAdyvPn3lBCTKn6t4HHAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/a0b58/jami-ingress.webp 230w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/bc10c/jami-ingress.webp 460w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/966d8/jami-ingress.webp 920w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/445df/jami-ingress.webp 1380w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/31418/jami-ingress.webp 1740w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/81c8e/jami-ingress.png 230w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/08a84/jami-ingress.png 460w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png 920w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/b1001/jami-ingress.png 1380w,\n/static/5e58e3883a2af493d0d9ea7491b7c97e/e67a8/jami-ingress.png 1740w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/5e58e3883a2af493d0d9ea7491b7c97e/c0255/jami-ingress.png\" alt=\"jami ingress\" title=\"jami ingress\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><exercise name='Exercise 4.01: Readiness Probe'><p>  Create a ReadinessProbe for the Ping-pong application. It should be ready when it has a connection to the database.</p><p>  And another ReadinessProbe for Log output application. It should be ready when it can receive data from the Ping-pong application.</p><p>  Test that it works by applying everything but the database statefulset. The output of <code class=\"language-text\">kubectl get po</code> should look like this before the database is available:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">NAME                             READY   STATUS    RESTARTS   AGE\nlogoutput-dep-7f49547cf4-ttj4f   1/2     Running   0          21s\npingpong-dep-9b698d6fb-jdgq9     0/1     Running   0          21s</code></pre></div><p>  Adding the database should automatically move the READY states to 2/2 and 1/1 for Log output and Ping-pong respectively.</p></exercise><p>Even though v2 didn't work, at least the application is working. We can just push a new update on top of the v2. Let's try the v4 which should break after a short while:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured</code></pre></div><p>Now the ReadinessProbe may pass for the first 20 seconds, but soon enough every pod will break. Unfortunately <em>ReadinessProbe</em> cannot do anything about it, the deployment was successful but the application is buggy.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl get po\n  NAME                               READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-dd78944f4-vv27w   0/1     Running   0          111s\n  flaky-update-dep-dd78944f4-dnmcg   0/1     Running   0          110s\n  flaky-update-dep-dd78944f4-zlh4v   0/1     Running   0          92s\n  flaky-update-dep-dd78944f4-zczmw   0/1     Running   0          90s</code></pre></div><p>Let's roll back to the previous version. This may come in handy, if you ever are in a panic mode and need to roll an update back:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl rollout undo deployment flaky-update-dep\n  deployment.apps/flaky-update-dep rolled back</code></pre></div><p>This will roll back into the previous version. Since it was v2, which doesn't work, we need to use a flag with the undo:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl describe deployment flaky-update-dep | grep Image\n    Image:        jakousa/dwk-app8:v2\n\n$ kubectl rollout undo deployment flaky-update-dep --to-revision=1\n  deployment.apps/flaky-update-dep rolled back\n\n$ kubectl describe deployment flaky-update-dep | grep Image\n    Image:        jakousa/dwk-app8:v1</code></pre></div><p>Read <code class=\"language-text\">kubectl rollout undo --help</code> to find out more!</p><p>There's another probe that could've helped us in a situation like the v4. <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes\" target=\"_blank\" rel=\"noopener noreferrer\"><em>LivenessProbes</em></a> can be configured similarly to <em>ReadinessProbes</em>, but if the check fails the container will be restarted.</p><p><strong>deployment.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Initial delay until the readiness is tested</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># How often to test</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n               <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span> <span class=\"token comment\"># Initial delay until the liveness is tested</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># How often to test</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n               <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>With this let's just deploy the worst of the versions, v3.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl apply -f deployment.yaml\n  deployment.apps/flaky-update-dep configured</code></pre></div><p>After a while, it may look something like this (if you're lucky).</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl get po\n  NAME                                READY   STATUS    RESTARTS   AGE\n  flaky-update-dep-fd65cd468-4vgwx   1/1     Running   3          2m30s\n  flaky-update-dep-fd65cd468-9h877   0/1     Running   4          2m49s\n  flaky-update-dep-fd65cd468-jpz2m   0/1     Running   3          2m13s\n  flaky-update-dep-fd65cd468-529nr   1/1     Running   4          2m50s</code></pre></div><p>At least something is working!</p><p>If your app is slow to start, a <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes\" target=\"_blank\" rel=\"noopener noreferrer\">StartupProbe</a> can be used to delay the liveness probe and prevent it from firing prematurely. You may require it in real life but is not discussed further in this course.</p><exercise name='Exercise 4.02: Project v1.7'><p>  Create the required probes and endpoint for The Project to ensure that it's working and connected to a database.</p><p>  Test that the probe indeed works with a version without database access, for example by supplying a wrong database URL or credentials.</p></exercise><h3 id=\"canary-release\" style=\"position:relative;\">Canary release<a href=\"#canary-release\" aria-label=\"canary release permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>With rolling updates, when including the Probes, we could create releases with no downtime for users. Sometimes this is not enough and you need to be able to do a <em>partial release</em> for some users and get data for the upcoming release. <a href=\"https://martinfowler.com/bliki/CanaryRelease.html\" target=\"_blank\" rel=\"noopener noreferrer\">Canary release</a> is the term used to describe a release strategy in which we introduce a subset of the users to a new version of the application. When the confidence in the new release grows, the number of users in the new version can be increased until the old version is no longer used.</p><p>At the moment of writing this, Canary is not a strategy for deployments that Kubernetes would provide out of the box. This may be due to the ambiguity of the methods for canary release. We will use <a href=\"https://argoproj.github.io/argo-rollouts/\" target=\"_blank\" rel=\"noopener noreferrer\">Argo Rollouts</a> to test one type of canary release:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl create namespace argo-rollouts\n$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml</code></pre></div><p>Now we have a new resource <a href=\"https://argoproj.github.io/argo-rollouts/migrating/\" target=\"_blank\" rel=\"noopener noreferrer\">Rollout</a> available to us. The Rollout will replace our previously created deployment and enable us to use a new field:</p><p><strong>rollout.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Rollout\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update<span class=\"token punctuation\">-</span>dep\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">canary</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pause</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> 30s\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pause</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">duration</span><span class=\"token punctuation\">:</span> 30s\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> flaky<span class=\"token punctuation\">-</span>update\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jakousa/dwk<span class=\"token punctuation\">-</span>app8<span class=\"token punctuation\">:</span>v1\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># Initial delay until the readiness is tested</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># How often to test</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n               <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span> <span class=\"token comment\"># Initial delay until the liveness is tested</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token comment\"># How often to test</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /healthz\n               <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3541</span></code></pre></div><p>The above strategy will first move 25% (<a href=\"https://argoproj.github.io/argo-rollouts/features/canary/#overview\" target=\"_blank\" rel=\"noopener noreferrer\"><em>setWeight</em></a>) of the pods to a new version (in our case 1 pod) after which it will wait for 30 seconds, move to 50% of pods and then wait for 30 seconds until every pod is updated. The <a href=\"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl plugin</a> from Argo also offers us <a href=\"https://argoproj.github.io/argo-rollouts/generated/kubectl-argo-rollouts/kubectl-argo-rollouts_promote/\" target=\"_blank\" rel=\"noopener noreferrer\">promote</a> command to enable us to pause the rollout indefinitely and then use the promote to move forward.</p><p>There are other options such as the <a href=\"https://argoproj.github.io/argo-rollouts/features/bluegreen/#maxunavailable\" target=\"_blank\" rel=\"noopener noreferrer\"><em>maxUnavailable</em></a> but the defaults will work for us. However, simply rolling slowly to production will not be enough for a canary deployment. Just like with rolling updates <em>we need to know the status of the application</em>.</p><p>With another custom resource we've already installed with Argo Rollouts called <a href=\"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun\" target=\"_blank\" rel=\"noopener noreferrer\">AnalysisTemplate</a> we will be able to define a test that doesn't let the broken versions through.</p><p>Let us extend our rollout with an analysis:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token punctuation\">...</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">canary</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">setWeight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">analysis</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">templates</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">templateName</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n    <span class=\"token comment\"># ...</span>\n  <span class=\"token punctuation\">...</span></code></pre></div><p>The analysis will be using a template called <em>restart-rate</em>. Next, we have to define how the analysis will be done. For that, we shall need Prometheus which we briefly used in <a href=\"/part-2/5-monitoring\">part 2</a>.</p><exercise name='Exercise 4.03: Prometheus'><p>  Ok, we started up Prometheus in part 2, but we have barely scratched the surface. Let's do a single hands-on query to learn more.</p><p>  Start now Prometheus with Helm and use port-forward to access the GUI website. Port 9090 is the default for Prometheus:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ kubectl -n prometheus get pods\n NAME                                                              READY   STATUS    RESTARTS   AGE\n  alertmanager-kube-prometheus-stack-1714-alertmanager-0            2/2     Running   0          3h19m\n  kube-prometheus-stack-1714-operator-94c596dbd-n5pcl               1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-grafana-54cbbc4c46-m26f6         3/3     Running   0          3h19m\n  kube-prometheus-stack-1714644114-kube-state-metrics-7cb796tpjbd   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-kdpln   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-sp9pg   1/1     Running   0          3h19m\n  kube-prometheus-stack-1714644114-prometheus-node-exporter-vbbjk   1/1     Running   0          3h19m\n  prometheus-kube-prometheus-stack-1714-prometheus-0                2/2     Running   0          3h19m\n\n$ kubectl -n prometheus port-forward prometheus-kube-prometheus-stack-1714-prometheus-0 9090:9090\n  Forwarding from 127.0.0.1:9090 -&gt; 9090\n  Forwarding from [::1]:9090 -&gt; 9090</code></pre></div><p>  And now accessing <a href=\"http://localhost:9090\" target=\"_blank\" rel=\"noopener noreferrer\">http://localhost:9090</a> will allow us to write queries.</p><p>  <strong>Write a query</strong> that shows the number of pods created by StatefulSets in <em>prometheus</em> namespace. For the above setup the <em>Value</em> should be 3 different pods:</p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 29.130434782608695%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3UlEQVQY032NbUoEMQyGexnP5w08jb+8hogHUBDRH4vM7M7uNP1M25m2aezuIIqgDyEkD7y8QmutbBhMNT5aTBrXUReLsb/Kp9FU5SJYBLcOumBIpVJjdolSIQHWgjyBVFpKM01eqSAhGoPauNPsQXkJYZZOm0ztTcF4PNw/TVc3u+u7WSxrtrERUWvEzP1qVC+bqNY+m+nfsqxH55Q1w+xvH+HhHQUobUP2IZZSnl9e15z5D3qeW+P2bQQi9s6erLV+DPtcyrn/wtbdvjj7H9FuBP/LlvlFzDwjp8yfyXxZomT2YzcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/9295ed50207655f31d8c229e0e61375b/a0b58/prometheus-p4.webp 230w,\n/static/9295ed50207655f31d8c229e0e61375b/bc10c/prometheus-p4.webp 460w,\n/static/9295ed50207655f31d8c229e0e61375b/966d8/prometheus-p4.webp 920w,\n/static/9295ed50207655f31d8c229e0e61375b/445df/prometheus-p4.webp 1380w,\n/static/9295ed50207655f31d8c229e0e61375b/78de1/prometheus-p4.webp 1840w,\n/static/9295ed50207655f31d8c229e0e61375b/3c376/prometheus-p4.webp 1998w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/9295ed50207655f31d8c229e0e61375b/81c8e/prometheus-p4.png 230w,\n/static/9295ed50207655f31d8c229e0e61375b/08a84/prometheus-p4.png 460w,\n/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png 920w,\n/static/9295ed50207655f31d8c229e0e61375b/b1001/prometheus-p4.png 1380w,\n/static/9295ed50207655f31d8c229e0e61375b/161ec/prometheus-p4.png 1840w,\n/static/9295ed50207655f31d8c229e0e61375b/1a867/prometheus-p4.png 1998w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/9295ed50207655f31d8c229e0e61375b/c0255/prometheus-p4.png\" alt=\"prometheus p4\" title=\"prometheus p4\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>  Query for \"kube_pod_info\" should have the required fields to filter through. See <a href=\"https://prometheus.io/docs/prometheus/latest/querying/basics/\" target=\"_blank\" rel=\"noopener noreferrer\">documentation</a> for help with querying.</p></exercise><p>The AnalysisTemplate will, in our case, use Prometheus to query the state of the deployment. The query result is then compared to a preset value. In this simplified case, if the number of overall restarts over the last 2 minutes is higher than two, it will fail the analysis. <em>initialDelay</em> will ensure that the test is not run until the data required is gathered. The template looks as follows:</p><p><strong>analysistemplate.yaml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AnalysisTemplate\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> restart<span class=\"token punctuation\">-</span>rate\n    <span class=\"token key atrule\">initialDelay</span><span class=\"token punctuation\">:</span> 2m\n    <span class=\"token key atrule\">successCondition</span><span class=\"token punctuation\">:</span> result &lt; 2\n    <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">prometheus</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//kube<span class=\"token punctuation\">-</span>prometheus<span class=\"token punctuation\">-</span>stack<span class=\"token punctuation\">-</span>1602<span class=\"token punctuation\">-</span>prometheus.prometheus.svc.cluster.local<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span> <span class=\"token comment\"># DNS name for my Prometheus, find yours with kubectl describe svc ...</span>\n        <span class=\"token key atrule\">query</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          scalar(\n            sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"}) -\n            sum(kube_pod_container_status_restarts_total{namespace=\"default\", container=\"flaky-update\"} offset 2m)\n          )</span></code></pre></div><p>With the new Rollout and AnalysisTemplate, we can safely try to deploy any version. Deploy for v2 is prevented with the Probes we set up. Deploy for v3 will automatically roll back when it notices that it has random crashes. The v4 will also eventually fail, but the short 2 minutes to test may still let a version get deployed.</p><p>The Argo Rollouts <a href=\"https://argoproj.github.io/argo-rollouts/features/kubectl-plugin/\" target=\"_blank\" rel=\"noopener noreferrer\">kubectl plugin</a> allows you to visualize the Rollout and its related resources. To watch the Rollout as it deploys, we can run it in watch mode:</p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl argo rollouts get rollout flaky-update-dep --watch</code></pre></div><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; margin-bottom: 1rem;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 54.78260869565218%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAABDklEQVQoz41S25KDIAwF5CIKyqWAo6h1pvv/v7in25dudx/IIEMkycnJgWzbxjkXQtRac85SSkIIY4y02HVdfd8LIdd1nedZKQV3GIamZKDFGBGttYZLGSVApU25JITwylyWBYV88CZyIdvaLqVYayml4El/rMPXBvxs23vfdV3rkN7NOYeeOZfveJgZykECXGGH+1LhL+eYUpgnDWDOnwtmzIhBQMBpmnAAL87/o4I7zHuv5TzW6759Pa4YbzknM5re9HWv0M5aU7Kz9lnxF7vJWhfT6G5ynJR12gQ8GQQZY6A5lMcTQs9Mctaxz1EiwmeXz1TOvD2W9SyAhWz4r0a1HzsIH8eRatKD/uj6G1OTEKJqQgCjAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/05739caf16d8b8b3e0410e1ac9814510/a0b58/rollout.webp 230w,\n/static/05739caf16d8b8b3e0410e1ac9814510/bc10c/rollout.webp 460w,\n/static/05739caf16d8b8b3e0410e1ac9814510/966d8/rollout.webp 920w,\n/static/05739caf16d8b8b3e0410e1ac9814510/445df/rollout.webp 1380w,\n/static/05739caf16d8b8b3e0410e1ac9814510/331b9/rollout.webp 1748w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/webp\">\n        <source srcset=\"/static/05739caf16d8b8b3e0410e1ac9814510/81c8e/rollout.png 230w,\n/static/05739caf16d8b8b3e0410e1ac9814510/08a84/rollout.png 460w,\n/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png 920w,\n/static/05739caf16d8b8b3e0410e1ac9814510/b1001/rollout.png 1380w,\n/static/05739caf16d8b8b3e0410e1ac9814510/7ef4c/rollout.png 1748w\" sizes=\"(max-width: 920px) 100vw, 920px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/05739caf16d8b8b3e0410e1ac9814510/c0255/rollout.png\" alt=\"rollout\" title=\"rollout\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span><p>Besides the pods, we see here also <a href=\"https://argoproj.github.io/argo-rollouts/architecture/#analysistemplate-and-analysisrun\" target=\"_blank\" rel=\"noopener noreferrer\">AnalysisRun</a> that is the instance of the test being run. You might also want to try Argo Rollouts <a href=\"https://argoproj.github.io/argo-rollouts/dashboard/\" target=\"_blank\" rel=\"noopener noreferrer\">dashboard</a>, which gives even fancier visualization of the state of your rollouts.</p><p>In general, the <em>AnalysisTemplate</em> is not dependent on Prometheus and could use a different source, such as a JSON endpoint, instead.</p><exercise name='Exercise 4.04: Project v1.8'><p>  Create an AnalysisTemplate for The Project that will follow the CPU usage of all containers in the namespace.</p><p>  If the CPU usage <strong>rate</strong> sum for the namespace increases above a set value (you may choose a good hardcoded value for your project) within 10 minutes, revert the update.</p><p>  Make sure that the application doesn't get updated, if the value is set too low.</p></exercise><h3 id=\"other-deployment-strategies\" style=\"position:relative;\">Other deployment strategies<a href=\"#other-deployment-strategies\" aria-label=\"other deployment strategies permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3><p>Kubernetes supports <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#recreate-deployment\" target=\"_blank\" rel=\"noopener noreferrer\">Recreate</a> strategy which takes down the previous pods and replaces everything with the updated one. This creates a moment of downtime for the application but ensures that different versions are not running at the same time. Argo Rollouts supports <a href=\"https://argoproj.github.io/argo-rollouts/features/bluegreen/\" target=\"_blank\" rel=\"noopener noreferrer\">BlueGreen</a> strategy, in which a new version is run side by side to the new one, but traffic is switched between the two at a certain point, such as after running update scripts or after your QA team has approved the new version.</p><exercise name='Exercise 4.05: Project v1.9'><p>  Speaking of updating.\nOur todo application could use \"Done\" field for todos that are already done.\nIt should be a PUT request to <code class=\"language-text\">/todos/&lt;id&gt;</code>.</p></exercise></div>","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"},"fileAbsolutePath":"/home/runner/work/kubernetes-hy.github.io/kubernetes-hy.github.io/data/part-4/1-update-strategies-and-prometheus.md"},"allPages":{"edges":[{"node":{"id":"e4e5fe1c-25b1-57b3-87eb-e204e767a49c","frontmatter":{"path":"/faq","title":"FAQ"}}},{"node":{"id":"9f6e26aa-46a9-523d-96e4-a57c65ec083d","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"3d7eac33-2990-59d1-a002-64e0b0f4f370","frontmatter":{"path":"/known-problems-solutions","title":"Issues you may face"}}},{"node":{"id":"57c61ed7-37c4-5d0f-acd8-1dca0de6be4a","frontmatter":{"path":"/registration-and-completion","title":"Registration and Completion"}}},{"node":{"id":"ecaa7011-87db-5ece-9b3c-1cfad638324a","frontmatter":{"path":"/","title":"Homepage"}}},{"node":{"id":"8ecc11b1-3298-589e-b97a-2a3a36861b8d","frontmatter":{"path":"/sanasto","title":"Sanasto"}}},{"node":{"id":"fb4fb717-329a-5d49-94c3-183aa16507e2","frontmatter":{"path":"/unity-assignment","title":"Unity Assignment"}}},{"node":{"id":"dab4b6a7-96cf-5efe-83f4-f5199c283e65","frontmatter":{"path":"/part-0","title":"Part 0"}}},{"node":{"id":"78948204-39a7-5f81-b9f4-3029400d5f82","frontmatter":{"path":"/part-1/2-introduction-to-debugging","title":"Introduction to Debugging"}}},{"node":{"id":"fe4a80ee-85ba-536e-bbf5-c5695399f40f","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"0b237cfb-5f2a-5d8e-9aa0-0cf9b045db3a","frontmatter":{"path":"/part-1/5-summary","title":"Summary"}}},{"node":{"id":"19841be9-897c-577a-9f82-5a7381bc073c","frontmatter":{"path":"/part-2/1-networking-between-pods","title":"Networking between pods"}}},{"node":{"id":"56f2a7a2-c9e2-5bbb-b6a7-76fd46592c69","frontmatter":{"path":"/part-2/5-monitoring","title":"Monitoring"}}},{"node":{"id":"f802a4ea-8d5a-503f-ad7b-d0138ab84c80","frontmatter":{"path":"/part-2/6-summary","title":"Summary"}}},{"node":{"id":"b810e0d9-0ac2-5073-a9dc-4ffd6649b7f7","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"40440141-c1a8-5723-858a-eea86119b5b6","frontmatter":{"path":"/part-3/4-summary","title":"Summary"}}},{"node":{"id":"708df9d2-30d1-518f-8066-80109a75c4dc","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"47a288aa-ece4-5ba6-ab6e-cbc63dbdc752","frontmatter":{"path":"/part-4/4-summary","title":"Summary"}}},{"node":{"id":"c8b1eb5e-3c98-59b3-b6e9-6173791d7e34","frontmatter":{"path":"/part-4","title":"Part 4"}}},{"node":{"id":"471982cb-da12-5799-a6b2-fa8a3e67aa0d","frontmatter":{"path":"/part-5/4-beyond-kubernetes","title":"Beyond Kubernetes"}}},{"node":{"id":"7bebb01b-c990-5e7e-a9aa-d60f10ba63dd","frontmatter":{"path":"/part-5/5-summary","title":"Summary and end"}}},{"node":{"id":"cbd58376-8d52-5297-b38d-653179a1226f","frontmatter":{"path":"/part-5","title":"Part 5"}}},{"node":{"id":"e4c53dca-867f-5293-9b28-657b695cd3f3","frontmatter":{"path":"/part-1/3-introduction-to-networking","title":"Introduction to Networking"}}},{"node":{"id":"fd6ebeaa-c808-5f11-9bdc-30e4f69b8a2a","frontmatter":{"path":"/part-1/4-introduction-to-storage","title":"Introduction to Storage"}}},{"node":{"id":"9e4ff8d0-2e6c-5d55-83a0-16ada460096d","frontmatter":{"path":"/part-2/2-organizing-a-cluster","title":"Organizing a cluster"}}},{"node":{"id":"0353d158-f751-57fd-94ce-373924da1b05","frontmatter":{"path":"/part-2/3-configuring-applications","title":"Configuring applications"}}},{"node":{"id":"eae6660d-1d18-527a-bc1c-0f2f7ab54c6d","frontmatter":{"path":"/part-2/4-statefulsets-and-jobs","title":"StatefulSets and Jobs"}}},{"node":{"id":"9f3c6f02-668a-517b-b7b6-1828f74c7200","frontmatter":{"path":"/part-3/1-introduction-to-gke","title":"Introduction to Google Kubernetes Engine"}}},{"node":{"id":"e80b74e8-a23b-5d3c-808b-833a72ac739c","frontmatter":{"path":"/part-3/2-deployment-pipeline","title":"Deployment Pipeline"}}},{"node":{"id":"78f84327-bd7b-5b5d-941d-9fae8bca88d3","frontmatter":{"path":"/part-3/3-gke-features","title":"GKE features"}}},{"node":{"id":"0a2d8cfd-8e40-59a7-a688-e8bdc9fb9e3a","frontmatter":{"path":"/part-4/3-gitops","title":"GitOps"}}},{"node":{"id":"39fb03b7-2abe-515a-a543-b812fcbfdba5","frontmatter":{"path":"/part-5/1-kubernetes-internals","title":"Kubernetes Internals"}}},{"node":{"id":"a899eeb2-4329-5c9b-aadf-2fb803fa9142","frontmatter":{"path":"/part-5/2-custom-resource-definitions","title":"Custom Resource Definitions"}}},{"node":{"id":"8a2e40fa-1703-5755-aa66-ac69bf2e291d","frontmatter":{"path":"/part-5/3-service-mesh","title":"Service Mesh"}}},{"node":{"id":"da15a80e-5316-5986-afcf-75d521065017","frontmatter":{"path":"/part-1/1-first-deploy","title":"First Deploy"}}},{"node":{"id":"f5314214-d779-5fb4-a19f-ab7442f3fbb2","frontmatter":{"path":"/part-4/2-messaging-systems","title":"Messaging Systems"}}},{"node":{"id":"33c86b5c-3684-5006-b4e7-dbd0c7cc04bc","frontmatter":{"path":"/part-4/1-update-strategies-and-prometheus","title":"Update Strategies and Prometheus"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}